"use strict";var CardTradeMode={CardTradeMode_ONLY_INSERT_CARD:1,CardTradeMode_ONLY_SWIPE_CARD:2,CardTradeMode_SWIPE_INSERT_CARD:5,CardTradeMode_UNALLOWED_LOW_TRADE:4,CardTradeMode_SWIPE_TAP_INSERT_CARD:3,CardTradeMode_SWIPE_TAP_INSERT_CARD_UNALLOWED_LOW_TRADE:6,CardTradeMode_ONLY_TAP_CARD:7,CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP:8,CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP_UNALLOWED_LOW_TRADE:9,CardTradeMode_TAP_INSERT_CARD:11,CardTradeMode_TAP_INSERT_CARD_NOTUP:10,CardTradeMode_SWIPE_TAP_INSERT_CARD_DOWN:12},EMVDataOperation={CLEAR:0,ADD:1,DELETE:2,ATTAINLIST:3,UPDATE:4,GETEMV:5},TransactionType={};function anlycPosInfo(){var e=upPLength();void 0;var t=0,r=getUpPByte(t++),n=byteArray2Hex(getUpPBytes(t,r));n=hex2Ascii(n),t+=r;var o=getUpPByte(t++),a=byteArray2Hex(getUpPBytes(t,o));a=hex2Ascii(a),t+=o;var s=getUpPByte(t++),i=byteArray2Hex(getUpPBytes(t,s)),u="";3<(i=hex2Ascii(i)).length&&(u=i.substr(3,s),i=i.substr(0,3)),t+=s;var l=getUpPByte(t++);void 0;var y=byteArrayToInt(getUpPBytes(t,l))+" mV";t+=l;var c=getUpPByte(t++),d=byteArray2Hex(getUpPBytes(t,c));d="00"==d?"false":"true",t+=c;var A=getUpPByte(t++),C=byteArray2Hex(getUpPBytes(t,A));C="00"==C?"false":"true",t+=A;var g=getUpPByte(t++),m=byteArray2Hex(getUpPBytes(t,g));m="00"==m?"false":"true",t+=g;var p=getUpPByte(t++),D=byteArray2Hex(getUpPBytes(t,p));D="00"==D?"false":"true",t+=p;var _=getUpPByte(t++),f=byteArray2Hex(getUpPBytes(t,_));f="00"==f?"false":"true";var R="";if((t+=_)<e){var E=getUpPByte(t++);R=byteArray2Hex(getUpPBytes(t,E)),t+=E}void 0;var T="";if(t<e){var P=getUpPByte(t++);T="00"==(T=byteArray2Hex(getUpPBytes(t,P)))?"false":"true",t+=P}var I="";if(t<e){var S=getUpPByte(t++);I="00"==(I=byteArray2Hex(getUpPBytes(t,S)))?"false":"true",t+=S}var M="";if(t<e){var v=getUpPByte(t++),b=getUpPBytes(t,v)[0];100<b?b=100:b<0&&(b=0),M=b.toString(10),M+="%",t+=v}return{isSupportedTrack1:m,isSupportedTrack2:D,isSupportedTrack3:f,bootloaderVersion:n,firmwareVersion:a,isUsbConnected:C,isCharging:d,batteryLevel:y,hardwareVersion:i,SUB:u,updateWorkKeyFlag:T,keyboardflag:I,batteryPercentage:M}}function anlycPosId(){var e=upPLength(),t=0,r=getUpPByte(t++),n=byteArray2Hex(getUpPBytes(t,r));t+=r;var o=getUpPByte(t++),a=byteArray2Hex(getUpPBytes(t,o));t+=o,void 0;var s=getUpPByte(t++);byteArray2Hex(getUpPBytes(t,s)),t+=s;var i=getUpPByte(t++);if(byteArray2Hex(getUpPBytes(t,i)),(t+=i)<e){var u=getUpPByte(t++);byteArray2Hex(getUpPBytes(t,u)),t+=u;var l=getUpPByte(t++);byteArray2Hex(getUpPBytes(t,l)),t+=l}var y="";if(t<e){var c=getUpPByte(t++);y=byteArray2Hex(getUpPBytes(t,c)),t+=c}if(t<e){var d=getUpPByte(t++);byteArray2Hex(getUpPBytes(t,d)),t+=d;var A=getUpPByte(t++);byteArray2Hex(getUpPBytes(t,A)),t+=A;var C=getUpPByte(t++);byteArray2Hex(getUpPBytes(t,C)),t+=C;var g=getUpPByte(t++);byteArray2Hex(getUpPBytes(t,g)),t+=g;var m=getUpPByte(t++);byteArray2Hex(getUpPBytes(t,m)),t+=m}if(t<e){var p=getUpPByte(t++);byteArray2Hex(getUpPBytes(t,p)),t+=p}return{posId:a,csn:y,psamId:n}}TransactionType.GOODS=1,TransactionType.SERVICES=2,TransactionType.CASH=3,TransactionType.CASHBACK=4,TransactionType.INQUIRY=5,TransactionType.TRANSFER=6,TransactionType.ADMIN=7,TransactionType.CASHDEPOSIT=8,TransactionType.PAYMENT=9,TransactionType.PBOCLOG=10,TransactionType.SALE=11,TransactionType.PREAUTH=12,TransactionType.ECQ_DESIGNATED_LOAD=16,TransactionType.ECQ_UNDESIGNATED_LOAD=17,TransactionType.ECQ_CASH_LOAD=18,TransactionType.ECQ_CASH_LOAD_VOID=19,TransactionType.ECQ_INQUIRE_LOG=17,TransactionType.REFUND=20,TransactionType.UPDATE_PIN=240;var CmdId={CMDID_WAITING:35,CMDID_QUERY:34,CMDID_PART_DATA:54,CMDID_OLD:0,CMDID_RESET:32,CMDID_PROCESS:33,CMDID_COMPLETED:36,CMDID_TIMEOUT:37,CMDID_DESTRUCT:38,CMDID_CRCERROR:39,CMDID_USERCANCEL:40,CMDID_MACERROR:41,CMDID_ICC_INIT_ERROR:48,CMDID_ICC_POWER_ON_ERROR:49,CMDID_ICC_TRADE_ERROR:50,CMDID_EMV_TRANS_TERMINATE:51,CMDID_EMV_TRANS_DENIAL:52,CMDID_NOT_AVAILABLE:53,CMDID_COMPLETED_ENCRY:136,CMDID_EMV_APP_CFG_ERROR:55,CMDID_EMV_CAPK_CFG_ERROR:56,CMDID_WR_DATA_ERROR:57,CMDID_NO_UPDATE_WORK_KEY:64,CMDID_INPUT_PIN_ING:65,CMDID_MAG_TO_ICC_TRADE:66,CMDID_SEND_IC_CARDNO:67,CMDID_EMV_TRANS_CARD_BLOCKED_OR_EMV_APPS:68,CMDID_EMV_TRANS_SELECT_APP_FAILED:69,CMDID_EMV_TRANS_CAPK_FAILED:70,CMDID_EMV_TRANS_FALLBACK:71,CMDID_EMV_TRANS_TERMINATE_NFC:72,CMDID_CARD_REMOVED:81,CMDID_MSR_DATA_READY:82,CMDID_EMV_KERNEL_PC:73,CMDID_CHECK_HAVE_CARD:137};function CommandDownlink(e,t,r){packCmmandDownlink(33,e,t,r,new Array)}function CommandDownlink2(e,t,r,n){packCmmandDownlink(33,e,t,r,n)}function CommandDownlink3(e,t,r,n,o){packCmmandDownlink(e,t,r,n,o)}function CommandDownlink4(e,t,r,n){packCmmandDownlink(e,t,r,n,new Array)}function getDownPByte(e){return getPByte(e)}function getDownPBytes(){return getPBytes()}function packCmmandDownlink(e,t,r,n,o){packet(o.length),setCmdID(e),setCmdCode(t),setCmdSubCode(r),setTimeOut(n),setDataField(o),buildCRC()}function commandCode(){return getCmdCode()}function subCommandCode(){return getCmdSubCode()}function getResult(){return getResultCode()}function commandID(){return getCmdID()}function upPLength(){var e=new Array;return e[0]=getPByte(3),e[1]=getPByte(4),byteArrayToInt(e)}function getUpPByte(e){return getDataFieldByte(e)}function getUpPBytes(e,t){for(var r=new Array,n=0;n<t;n++)r[n]=getDataFieldByte(e+n);return r}function getAllBytes(){return getPBytes()}function validCRC(){return validPCRC()}function packageCommandUplink(e){var t=hexStr2Bytes(e.substring(10,e.length));packet(e.length/2-5),setCmdID(CmdId.CMDID_COMPLETED),setCmdCode(parseInt(e.substring(0,2),16)),setCmdSubCode(parseInt(e.substring(2,4),16)),setTimeOut(0),setDataField(t),buildCRC()}var pinStr,pinMode,mTradeAmount,mCurrencyCode,mCashbackAmount,mTradeType,DoTrade=function(e){writeObj(e),mListener=e,void 0,writeObj(this)},EmvOption={START:0,START_WITH_FORCE_ONLINE:1},DoTradeMode={COMMON:0,CHECK_CARD_NO_IPNUT_PIN:1,IS_DEBIT_OR_CREDIT:2},TransactionResult={APPROVED:"APPROVED",TERMINATED:"TERMINATED",DECLINED:"DECLINED",CANCEL:"CANCEL",CAPK_FAIL:"CAPK_FAIL",NOT_ICC:"NOT_ICC",SELECT_APP_FAIL:"SELECT_APP_FAIL",DEVICE_ERROR:"DEVICE_ERROR",CARD_NOT_SUPPORTED:"CARD_NOT_SUPPORTED",MISSING_MANDATORY_DATA:"MISSING_MANDATORY_DATA",CARD_BLOCKED_OR_NO_EMV_APPS:"CARD_BLOCKED_OR_NO_EMV_APPS",INVALID_ICC_DATA:"INVALID_ICC_DATA",FALLBACK:"FALLBACK",NFC_TERMINATED:"NFC_TERMINATED",CARD_REMOVED:"CARD_REMOVED",TRADE_LOG_FULL:"TRADE_LOG_FULL",TRANSACTION_NOT_ALLOWED_AMOUNT_EXCEED:"TRANSACTION_NOT_ALLOWED_AMOUNT_EXCEED"},mDoTradeMode=DoTradeMode.COMMON,mCardTmode=CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD,mAmountIcon="",cDisplayStr="",mFormatId="",mBatchId="",mAmountPoint="",mSaveLogFlag="",mIsSupportCashBack=!1,FINA_CONFIRM="03",BATCH_DC="04",OFFLINE_ADVICE="05",ONLINE_ADVICE="06",REVERSAL="07",EMV_TRANS_ACCEPT="01",EMV_TRANS_DENIAL="02",EMV_TRANS_GOONLINE="03";function setAmountPoint(e){mAmountPoint=e?"01":"00"}function sendPin(e){pinMode="00",pinMode=""==(pinStr=e)||null==pinStr?"00":"01",void 0,EMVCvmSetPin(e)}function isSavelog(e){mSaveLogFlag=e?"01":"00"}function setAmount(e,t,r,n){void 0,mTradeAmount=e,mCashbackAmount=t,mCurrencyCode=r,void 0,mTradeType=toHex(n).substr(2,2),void 0}var datas,encMode,AmountType={MONEY_TYPE_NONE:1,MONEY_TYPE_RMB:2,MONEY_TYPE_DOLLAR:3,MONEY_TYPE_CUSTOM_STR:4};function setAmountIcon(e,t){void 0;var r="";if(e==AmountType.MONEY_TYPE_NONE)r="01";else if(e==AmountType.MONEY_TYPE_RMB)r="02";else if(e==AmountType.MONEY_TYPE_DOLLAR)r="03";else if(e==AmountType.MONEY_TYPE_CUSTOM_STR)return void(null!=(mAmountIcon=t)&&""!=t&&(mAmountIcon=byteArray2Hex(getUTF8Bytes(t.trim()))));this.amountIcon=r}function setDoTradeMode(e){mDoTradeMode=e}function setFormatId(e){mFormatId=e}function setBatchId(e){mBatchId=e}function setCardTmodeMode(e){mCardTmode=e}function doTrade(e,t){10<=e||EmvPolCard(mTradeAmount,t,mAmountIcon,e,mCardTmode,mTradeType,mCurrencyCode,cDisplayStr)}function EmvPolCard(e,t,r,n,o,a,s,i){var u=0,l=new Array,y=new Array,c=new Array,d=new Array,A=new Array,C=new Array,g=new Array,m=new Array,p=new Array,D=new Array,_=0;isEmpty(r)||(_=(l=hexStr2Bytes(r.trim())).length);var f=0;isEmpty(e)||(f=(y=getUTF8Bytes(e.trim())).length);var R=getFormatDateyyyyMMddHHmmss(),E=0;isEmpty(R)||(E=(c=hexStr2Bytes(R.trim())).length);var T=0,P=i;isEmpty(P)||(T=(d=hexStr2Bytes(P.trim())).length);var I=0;isEmpty(mFormatId)||(I=(A=hexStr2Bytes(mFormatId.trim())).length);var S=0;isEmpty(mBatchId)||(S=(C=hexStr2Bytes(mBatchId.trim())).length);var M=0;isEmpty(mAmountPoint)||(M=(g=hexStr2Bytes(mAmountPoint.trim())).length);var v=0;isEmpty(mSaveLogFlag)||(v=(m=hexStr2Bytes(mSaveLogFlag.trim())).length);var b=0;isEmpty("00")||(b=(p=hexStr2Bytes("00".trim())).length);var O=(D=hexStr2Bytes("313431323137")).length,h=new Array(1+f+1+1+_+1+1+E+1+1+1+1+1+1+2+1+T+8+1+I+1+S+1+M+1+v+1+b+1+O);h[u++]=f,arrCopyArr(y,0,h,u,f),u+=f,o==CardTradeMode.CardTradeMode_ONLY_INSERT_CARD?h[u++]=1:o==CardTradeMode.CardTradeMode_ONLY_SWIPE_CARD?h[u++]=2:o==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD?h[u++]=3:o==CardTradeMode.CardTradeMode_UNALLOWED_LOW_TRADE?h[u++]=4:o==CardTradeMode.CardTradeMode_SWIPE_INSERT_CARD?h[u++]=5:o==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_UNALLOWED_LOW_TRADE?h[u++]=6:o==CardTradeMode.CardTradeMode_ONLY_TAP_CARD?h[u++]=7:o==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP?h[u++]=8:o==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP_UNALLOWED_LOW_TRADE?h[u++]=9:o==CardTradeMode.CardTradeMode_TAP_INSERT_CARD?h[u++]=11:o==CardTradeMode.CardTradeMode_TAP_INSERT_CARD_NOTUP?h[u++]=10:o==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_DOWN?h[u++]=12:h[u++]=3,h[u++]=_,arrCopyArr(l,0,h,u,_),u+=_,mDoTradeMode==DoTradeMode.CHECK_CARD_NO_IPNUT_PIN?h[u++]=1:mDoTradeMode==DoTradeMode.IS_DEBIT_OR_CREDIT?h[u++]=3:h[u++]=0,h[u++]=E,arrCopyArr(c,0,h,u,E),u+=E,h[u++]=0,h[u++]=0,h[u++]=n,h[u++]=0,h[u++]=1,isEmpty(a)&&(a="01"),h[u++]=hexStr2Bytes(a)[0],isEmpty(s)&&(s="0156"),3==s.length&&(s="0"+s),h[u++]=hexStr2Bytes(s)[0],h[u++]=hexStr2Bytes(s)[1],h[u++]=T,arrCopyArr(d,0,h,u,T),u+=T,h[u++]=I,arrCopyArr(A,0,h,u,A.length),u+=I,h[u++]=S,arrCopyArr(C,0,h,u,C.length),u+=S,h[u++]=M,arrCopyArr(g,0,h,u,g.length),u+=M,h[u++]=v,arrCopyArr(m,0,h,u,m.length),u+=v,h[u++]=b,arrCopyArr(p,0,h,u,p.length),u+=b,h[u++]=O,arrCopyArr(D,0,h,u,D.length),u+=O,arrCopyArr(calMac(h,h.length-8),0,h,u,8),u+=8,mListener.onRequestWaitingUser(),CommandDownlink2(22,32,t,h);var L=getDownPBytes();startSession(new Uint8Array(L).buffer,onReceiveDateListener,15)}function EMVCvmSetPin(e){var t=0,r=new Array(512);if(r[t++]=hexStr2Bytes(pinMode)[0],""==e||null==e){r[t++]=0,r[t++]=1,r[t++]=0,arrCopyArr(r,0,o=new Array(t),0,t),CommandDownlink2(22,52,60,o);var n=getDownPBytes();startSession(new Uint8Array(n).buffer,onReceiveDateListener,15)}else{var o,a=getUTF8Bytes(e);r[t++]=a.length,arrCopyArr(a,0,r,t,a.length),t+=a.length,r[t++]=1,r[t++]=0,arrCopyArr(r,0,o=new Array(t),0,t),CommandDownlink2(22,52,60,o);n=getDownPBytes();startSession(new Uint8Array(n).buffer,onReceiveDateListener,15)}}function onReceiveDateListener(e){if(void 0,"01"==e.substring(18,20)&&"1620"==e.substring(8,12)){mListener.onDoTradeResult(DoTradeResult.ICC,null),CommandDownlink2(22,48,60,EMVStart(EmvOption.START));var t=getDownPBytes();void 0,startSession(new Uint8Array(t).buffer,onReceiveDateListener,5)}else if("00"==e.substring(18,20)&&"1620"==e.substring(8,12))checkCardResult(DoTradeResult.MCR,e);else if("03"==e.substring(18,20)&&"1620"==e.substring(8,12))checkCardResult(DoTradeResult.NFC_ONLINE,e);else if("04"==e.substring(18,20)&&"1620"==e.substring(8,12))checkCardResult(DoTradeResult.NFC_OFFLINE,e);else if("05"==e.substring(18,20)&&"1620"==e.substring(8,12))mListener.onDoTradeResult(DoTradeResult.NFC_DECLINED,null);else if("24"==e.substring(6,8)&&"1634"==e.substring(8,12)){var r=parseInt(e.substring(14,18),16);continueEmvProcess(n=e.substring(18,18+2*r))}else if("32"==e.substring(6,8)&&"1634"==e.substring(8,12))mListener.onRequestSetPin();else if("24"==e.substring(6,8)&&"1630"==e.substring(8,12)){r=parseInt(e.substring(14,18),16);var n=e.substring(18,18+2*r);if(void 0,void 0,"02"==e.substring(12,14)){var o=new Array,a=0,s=parseInt(n.substring(a,a+2),16);void 0,a+=2;for(var i=0;i<s;i++){a+=2,a+=2;var u=parseInt(n.substring(a,a+2),16);a+=2;var l=hex2Ascii(n.substring(a,a+2*u));a+=2*u,o.push(l)}mListener.onRequestSelectEmvApp(o)}else"31"==e.substring(12,14)||"32"==e.substring(12,14)?mListener.onRequestSetPin():continueEmvProcess(n)}else if("241640"==e.substring(6,12)){void 0;r=parseInt(e.substring(14,18),16);void 0;n=bufData+e.substring(18,18+2*r);void 0;var y=Str2Bytes(n);void 0;var c=analysisEmvResult(y),d=c[0],A=c[1],C=(c[2],c[3],c[4]);void 0,d==EMV_TRANS_ACCEPT?A==REVERSAL?(mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onReturnReversalData(C),mListener.onRequestTransactionResult(TransactionResult.DECLINED)):A!=FINA_CONFIRM&&A!=BATCH_DC||(mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onRequestBatchData(C),mListener.onRequestTransactionResult(TransactionResult.APPROVED)):d==EMV_TRANS_DENIAL&&(A==ONLINE_ADVICE||A==OFFLINE_ADVICE?(mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onRequestBatchData(C),mListener.onRequestTransactionResult(TransactionResult.DECLINED)):REVERSAL==A&&(mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onReturnReversalData(C),mListener.onRequestTransactionResult(TransactionResult.DECLINED)))}}function continueEmvProcess(e){var t=analysisEmvResult(hexStr2Bytes(e)),r=t[0],n=(t[1],t[2],t[3],t[4]);EMV_TRANS_GOONLINE==r?mListener.onRequestOnlineProcess(n):emvGoOffLine(t)}function emvGoOffLine(e){var t=e[0],r=e[1],n=(e[2],e[3],e[4]);if(EMV_TRANS_DENIAL==t){if(ONLINE_ADVICE==r||OFFLINE_ADVICE==r)return mListener.onReqestDisplay(Display.REMOVE_CARD),mListener.onRequestBatchData(n),void mListener.onRequestTransactionResult(TransactionResult.DECLINED);if(REVERSAL==r)return mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onReturnReversalData(n),void mListener.onRequestTransactionResult(TransactionResult.DECLINED)}else if(EMV_TRANS_ACCEPT==t){if(REVERSAL==r)return mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onReturnReversalData(n),void mListener.onRequestTransactionResult(TransactionResult.DECLINED);if(FINA_CONFIRM==r||BATCH_DC==r)return mListener.onRequestDisplay(Display.REMOVE_CARD),mListener.onRequestBatchData(n),void mListener.onRequestTransactionResult(TransactionResult.APPROVED)}startSysSession(packageInstructionReset(),null,5),logListaner="onError(Error.UNKNOWN)",void 0}function EMVSelectEMVApp(e){var t=new Array;t.push(e),CommandDownlink2(22,49,30,t);var r=getDownPBytes();void 0,startSysSession(new Uint8Array(r).buffer,null,60).then(function(e){if(0==getResult()){var t=upPLength();void 0;continueEmvProcess(byteArray2Hex(getUpPBytes(0,t)))}},function(e){void 0})}function EMVGoOnLine(e){CommandDownlink2(22,64,30,hexStr2Bytes(e));var t=getDownPBytes();void 0,startSession(new Uint8Array(t).buffer,onReceiveDateListener,60)}function checkCardResult(e,t){var r=new Array;void 0;var n=hexStr2Bytes(t.substring(14,14+t.length-16)),o=(n[2],4),a=n.length,s=n[o++],i=byteArray2Hex(getBytesFromArr(o,s,n));o+=s,r.push(i);var u=n[o++],l=byteArray2Hex(getBytesFromArr(o,u,n));o+=u,r.push(l);var y=n[o++],c=byteArray2Hex(getBytesFromArr(o,y,n));o+=y,r.push(c);var d=n[o++],A=ab2str(getBytesFromArr(o,d,n));o+=d,r.push(A);var C=n[o++],g=ab2str(getBytesFromArr(o,C,n));o+=C,r.push(g);var m=n[o++],p=ab2str(getBytesFromArr(o,m,n));o+=m,r.push(p);var D=n[o++],_=ab2str(getBytesFromArr(o,D,n));o+=D,r.push(_);var f=n[o++],R=ab2str(getBytesFromArr(o,f,n));o+=f,r.push(R);var E=n[o++],T=byteArray2Hex(getBytesFromArr(o,E,n));o+=E,r.push(T);var P=n[o++],I=byteArray2Hex(getBytesFromArr(o,P,n));o+=P,r.push(I);var S,M,v=n[o++],b=byteArray2Hex(getBytesFromArr(o,v,n));if(o+=v,r.push(b),o<a){var O=n[o++];S=byteArray2Hex(getBytesFromArr(o,O,n)),o+=O,r.push(S);var h=n[o++];M=byteArray2Hex(getBytesFromArr(o,h,n)),o+=h,r.push(M)}else M=S="";var L,U="";if(o<a){var N=n[o++];U=ab2str(getBytesFromArr(o,N,n)),o+=N,r.push(U)}if(o<a){var w=new Array(1);w[0]=n[o++];var B=byteArrayToInt(w),x=new Array(1);x[0]=n[o++];var H=byteArrayToInt(x),k=new Array(1);k[0]=n[o++];var F=byteArrayToInt(k);B.toString(),H.toString(),F.toString()}else 0;if(o<a){var V=n[o++];L=byteArray2Hex(getBytesFromArr(o,V,n)),o+=V}else L="";r.push(L);l.toString(),c.toString();mListener.onDoTradeResult(e,r)}function getNFCBatchData(t,r){getICCTag(1,0,"").then(function(e){if(0==getResult()){e=byteArray2Hex(getUpPBytes(0,upPLength()));t(e)}},function(e){r(e),void 0})}function getICCTag(e,t,r){new Array;var n="00";n+=byteArray2Hex(intToHex(e)),n+=byteArray2Hex(intToHex(e)),n+=byteArray2Hex(intToHex(t)),isEmpty(r)&&(r="00"),CommandDownlink2(22,81,5,hexStr2Bytes((n+=r).trim()));var o=getDownPBytes();return void 0,startSysSession(new Uint8Array(o).buffer,null,5)}function analysisEmvResult(e){void 0;var t=new Array;if(null==e||0==e.length)return t;var r=0;r++,encMode=e[r++];var n=new Array(1);n[0]=e[r++];var o=byteArray2Hex(n),a=new Array(1);a[0]=e[r++];var s=byteArray2Hex(a),i=new Array(1);i[0]=e[r++];var u=byteArrayToInt(i),l=new Array(u);arrCopyArr(e,r,l,0,u);var y=byteArray2Hex(l);r+=u;var c=e[r++];arrCopyArr(e,r,l=new Array(c),0,c);var d=byteArray2Hex(l);r+=c;var A=new Array(2);A[0]=e[r],A[1]=e[r+1];var C=byteArrayToInt(A);arrCopyArr(e,r+=2,l=new Array(C),0,C);var g=byteArray2Hex(l),m="";if((r+=C)<e.length){var p=byteArray2Hex(l=intToHex(C));2==p.length&&(p="00"+p),g=p+g;var D=e.length-r;arrCopyArr(e,r,l=new Array(D),0,D),m=byteArray2Hex(l),r+=C}return g+=m,t.push(o),t.push(s),t.push(y),t.push(d),t.push(g),void 0,t}function anlysDataCommon(e,t){var r=new Array;if(0==encMode||16==encMode||38==encMode||48==encMode)return r.push(t),r;var n=Str2Bytes(t),o=n.length,a=0,s=new Array(2);s[0]=n[a],s[1]=n[a+1];var i=byteArrayToInt(s);a+=2;var u=new Array(i);arrCopyArr(n,a,u,0,i);var l=byteArray2Hex(u);if(o<=(a+=i))return r.push(l),r;a+=2;var y=n[a++],c=new Array(y);arrCopyArr(n,a,c,0,y);var d=byteArray2Hex(c);a+=y;var A=n[a++];arrCopyArr(n,a,c=new Array(A),0,A);var C=byteArray2Hex(c);a+=A;var g=n[a++];arrCopyArr(n,a,c=new Array(g),0,g);var m=byteArray2Hex(c);a+=g;var p=n[a++];arrCopyArr(n,a,c=new Array(p),0,p);var D=ab2str(c);a+=p;var _=n[a++];arrCopyArr(n,a,c=new Array(_),0,_);var f=ab2str(c);a+=_;var R=n[a++];arrCopyArr(n,a,c=new Array(R),0,R);var E=ab2str(c);a+=R;var T=n[a++];arrCopyArr(n,a,c=new Array(T),0,T);var P=ab2str(c);a+=T;var I=n[a++],S=ab2str(c);a+=I;var M=n[a++];arrCopyArr(n,a,c=new Array(M),0,M);var v=byteArray2Hex(c);a+=M;var b=n[a++];arrCopyArr(n,a,c=new Array(b),0,b);var O=byteArray2Hex(c);a+=b;var h=n[a++];arrCopyArr(n,a,c=new Array(h),0,h);var L=byteArray2Hex(c),U="",N="";if((a+=h)<o){var w=n[a++];arrCopyArr(n,a,c=new Array(w),0,w),U=byteArray2Hex(c),a+=w}if(a<o){var B=n[a++];arrCopyArr(n,a,c=new Array(B),0,B),N=byteArray2Hex(c),a+=B}var x="";if(a<o){var H=n[a++];arrCopyArr(n,a,c=new Array(H),0,H),x=ab2str(c),a+=H}var k="",F="",V="";a<o&&(k=n[a++]+"",F=n[a++]+"",V=n[a++]+"");var K="";if(a<o){var G=n[a++];arrCopyArr(n,a,c=new Array(G),0,G),K=byteArray2Hex(c),a+=G}var W="";if(a<o){var Q=n[a++],Y=new Array(Q);arrCopyArr(n,a,Y,0,Q),W=byteArray2Hex(Y),a+=Q}if(a<o){var q=n[a++],j=new Array(q);arrCopyArr(n,a,j,0,q),byteArray2Hex(j),a+=q}return r.push(D),r.push(f),r.push(E),r.push(S),r.push(P),r.push(k),r.push(F),r.push(V),r.push(d),r.push(C),r.push(m),r.push(v),r.push(U),r.push(N),r.push(x),r.push(K),r.push(l),r.push(W),r.push(O),r.push(L),void 0,r}function EMVStart(e){void 0;var t,r=19+mTradeAmount.length+1+mCashbackAmount.length+2+1,n=new Array(r),o=0;e==EmvOption.START?n[o++]=0:e==EmvOption.START_WITH_FORCE_ONLINE&&(n[o++]=1),n[o++]=hexStr2Bytes(mTradeType)[0];var a=getFormatDateyyyyMMddHHmmss();arrCopyArr(t=mTradeAmount.length<=8?hexStr2Bytes(a+"FF"):hexStr2Bytes(a+"06"),0,n,o,t.length),o+=t.length;var s="";s=8<mTradeAmount.length?"FFFFFFFFFFFF":"FFFFFFFF";var i=0;return isEmpty(mTradeAmount)||(i=mTradeAmount.length),arrCopyArr(t=hexStr2Bytes(s=s.substring(0,s.length-i)+mTradeAmount),0,n,o,t.length),o+=t.length,s=8<mTradeAmount.length?"":"0000",3==mCurrencyCode.length&&(mCurrencyCode="0"+mCurrencyCode),arrCopyArr(t=hexStr2Bytes(s+=mCurrencyCode),0,n,o,t.length),o+=t.length,n[o++]=mTradeAmount.length+1,arrCopyArr(getUTF8Bytes(mTradeAmount),0,n,o,mTradeAmount.length),o+=mTradeAmount.length,n[o++]=0,n[o++]=mCashbackAmount.length+1,arrCopyArr(getUTF8Bytes(mCashbackAmount),0,n,o,mCashbackAmount.length),o+=mCashbackAmount.length,n[o++]=0,arrCopyArr(intToHex(20),0,n,o++,1),n}DoTrade.prototype.doTrade=function(e,t){doTrade(e,t)},DoTrade.prototype.sendPin=function(e){sendPin(e)},DoTrade.prototype.doCheckCard=function(e,t){setDoTradeMode(DoTradeMode.CHECK_CARD_NO_IPNUT_PIN),doTrade(e,t)},DoTrade.prototype.selectEmvApp=function(e){void 0,EMVSelectEMVApp(e)},DoTrade.prototype.sendOnlineProcessResult=function(e){void 0,EMVGoOnLine(e)},DoTrade.prototype.getNFCBatchData=function(e,t){return getNFCBatchData(e,t)},DoTrade.prototype.getICCTag=function(e,t,r){return getICCTag(e,t,r)};var mOperationType,EMVManager=function(e){writeObj(e),mListener=e,void 0,writeObj(this)};EMVManager.prototype.updateEmvAPP=function(e,t){updateEmvAPP(e,t)},EMVManager.prototype.updateEmvCAPK=function(e,t){updateEmvCAPK(e,t)},EMVManager.prototype.updateEmvConfig=function(e,t){updateEmvConfig(e,t)};var WRITE_MAX_LEN=100;function updateEmvAPP(e,t){if(null!=e&&null!=e){isEmpty(t)&&(t=""),CommandDownlink2(23,160,15,hexStr2Bytes(updateEMV(mOperationType=e,t)));var r=getDownPBytes();void 0,startSession(new Uint8Array(r).buffer,onReturnUpdateEmvAPPResult,5)}}function updateEMV(e,t){var r="";switch(e){case EMVDataOperation.CLEAR:r="01";break;case EMVDataOperation.ADD:r="02"+t;break;case EMVDataOperation.DELETE:r="03"+t;break;case EMVDataOperation.ATTAINLIST:r="04";break;case EMVDataOperation.UPDATE:r="05"+t;break;case EMVDataOperation.GETEMV:r="06"+t}return r}function onReturnUpdateEmvAPPResult(e){if(void 0,0==getResult())if(mOperationType==EMVDataOperation.ATTAINLIST){for(var t=byteArray2Hex(getUpPBytes(0,upPLength())),r=0,n=t.substring(0,2),o=0;o<t.length;o++)1==t.search("1000000000000000000000000000000000")&&(r=parseInt(n,16)-1,t=t.replace("1000000000000000000000000000000000",""),n=r<17?"0"+toHex(r).substr(2,2).toUpperCase():toHex(r).substr(2,2).toUpperCase());t=n+t.slice(2),void 0,mListener.onReturnGetEMVListResult(t)}else if(mOperationType==EMVDataOperation.GETEMV){var a=byteArray2Hex(getUpPBytes(0,upPLength()));void 0,mListener.onReturnGetEMVListResult(a)}else void 0,mListener.onReturnUpdateEMVResult(!0);else void 0,mListener.onReturnUpdateEMVResult(!1);mOperationType=null}function updateEmvCAPK(e,t){if(null!=e&&null!=e&&e!=EMVDataOperation.UPDATE){isEmpty(t)&&(t=""),CommandDownlink2(23,161,15,hexStr2Bytes(updateEMV(mOperationType=e,t)));var r=getDownPBytes();void 0,startSession(new Uint8Array(r).buffer,onReturnUpdateEmvCAPKResult,5)}}function onReturnUpdateEmvCAPKResult(e){if(void 0,0==getResult())if(mOperationType==EMVDataOperation.ATTAINLIST){for(var t=byteArray2Hex(getUpPBytes(0,upPLength())),r=0,n=t.substring(0,2),o=0;o<t.length;o++)1==t.search("1000000000000000000000000000000000")&&(r=parseInt(n,16)-1,t=t.replace("1000000000000000000000000000000000",""),n=r<17?"0"+toHex(r).substr(2,2).toUpperCase():toHex(r).substr(2,2).toUpperCase());t=n+t.slice(2),void 0,mListener.onReturnGetEMVListResult(t)}else if(mOperationType==EMVDataOperation.GETEMV){var a=byteArray2Hex(getUpPBytes(0,upPLength()));void 0,mListener.onReturnGetEMVListResult(a)}else void 0,mListener.onReturnUpdateEMVRIDResult(!0);else void 0,mListener.onReturnUpdateEMVRIDResult(!1);mOperationType=null}var mEmvAppCfg="",mEmvCapkCfg="";function updateEmvConfig(e,t){isEmpty(e)||e.length%2!=0||isEmpty(t)||t.length%2!=0||(mOffset=0,mCustomParamString="",mCustomParam=null,mEmvCapkCfg=t,doUpdateCustomParam(CustomParam.CUSTOM_PARAM_SEG_EMV_APP,0,e))}var mCustomParam,mOffset=0,mCustomParamString="";function doUpdateCustomParam(e,t,r){mOffset=t,mCustomParam=e;var n=(mCustomParamString=r).length/2;startSendCustomParam(OperationLogo.WRITE,e,n).then(function(e){if(0==getResult())return void 0,updateCustomParam()},function(e){void 0})}function startSendCustomParam(e,t,r){var n="";e==OperationLogo.READ?n+="00":n+="01",t==CustomParam.CUSTOM_PARAM_SEG_EMV_APP?n+="00":t==CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK?n+="01":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM1?n+="02":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM2&&(n+="03");var o=r>>16&255,a=r>>8&255,s=255&r;n+=byteArray2Hex(intToHex(r>>24)),n+=byteArray2Hex(intToHex(o)),n+=byteArray2Hex(intToHex(a)),n+=byteArray2Hex(intToHex(s)),CommandDownlink2(22,144,15,hexStr2Bytes(n+="10"));var i=getDownPBytes();return void 0,startSysSession(new Uint8Array(i).buffer,null,5)}var mUpdateCustomParamResolve=function(){void 0},mUpdateCustomParamReject=function(){void 0};function updateCustomParam(){var e="",t=hexStr2Bytes(mCustomParamString),r=mCustomParamString.length/2,n=mOffset,o=n>>16&255,a=n>>8&255,s=255&n;e=byteArray2Hex(intToHex(n>>24)),e+=byteArray2Hex(intToHex(o)),e+=byteArray2Hex(intToHex(a)),e+=byteArray2Hex(intToHex(s)),WRITE_MAX_LEN<(n=r-mOffset)&&(n=WRITE_MAX_LEN),s=255&n,e+=byteArray2Hex(intToHex(a=n>>8&255)),e+=byteArray2Hex(intToHex(s));var i=new Array(n);arrCopyArr(t,mOffset,i,0,n),CommandDownlink2(22,160,15,hexStr2Bytes(e+=byteArray2Hex(i)));var u=getDownPBytes();void 0,mOffset+=n,startSession(new Uint8Array(u).buffer,onUpdateCustomParam,5)}function onUpdateCustomParam(e){if(void 0,0==getResult()){var t=mCustomParamString.length/2;mOffset<t?(void 0,updateCustomParam()):(void 0,stopSendCustomParam(OperationLogo.WRITE,mCustomParam))}else mListener.onReturnCustomConfigResult(!1)}function stopSendCustomParam(e,t){void 0;var r="";e==OperationLogo.READ?r+="00":r+="01",t==CustomParam.CUSTOM_PARAM_SEG_EMV_APP?r+="00":t==CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK?r+="01":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM1?r+="02":t==CustomParam.CUSTOM_PARAM_SEG_CUSTOM2&&(r+="03"),CommandDownlink2(22,145,15,hexStr2Bytes(r));var n=getDownPBytes();void 0,t==CustomParam.CUSTOM_PARAM_SEG_EMV_APP?startSysSession(new Uint8Array(n).buffer,null,5).then(function(e){doUpdateCustomParam(CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK,0,mEmvCapkCfg)},function(e){}):(startSysSession(new Uint8Array(n).buffer,null,5),mListener.onReturnCustomConfigResult(!0))}var mParas,OperationLogo={READ:0,WRITE:1},CustomParam={CUSTOM_PARAM_SEG_CUSTOM1:0,CUSTOM_PARAM_SEG_CUSTOM2:1,CUSTOM_PARAM_SEG_EMV_APP:2,CUSTOM_PARAM_SEG_EMV_CAPK:3},GetMifareCardInfo=function(e){writeObj(e),mListener=e,void 0,writeObj(this)};function pollOnMifareCard(e){doMifareCard("01",e)}function finishMifareCard(e){doMifareCard("0E",e)}function doMifareCard(e,t){CommandDownlink2(23,128,t,hexStr2Bytes(mParas=e));var r=getDownPBytes();void 0,startSession(new Uint8Array(r).buffer,onSearchMifareCardResult,5)}function onSearchMifareCardResult(e){void 0;var t=1;if(0==getResult()){if("01"==mParas){var r=intToHexValue(getUpPBytes(t++,1)),n=intToHexValue(getUpPBytes(t++,1));void 0;var o=byteArray2Hex(getUpPBytes(t,2)),a=byteArray2Hex(getUpPBytes(t+=2,1));void 0,t+=1;var s=getUpPBytes(t++,1),i=byteArray2Hex(getUpPBytes(t,s));t+=s;var u=getUpPBytes(t++,1),l="";0!=u&&(l=byteArray2Hex(getUpPBytes(t,u))),void 0;var y={cardType:n,ATQA:o,SAK:a,cardUidLen:s+"",cardUid:i,cardAtsLen:u+"",cardAts:l};y.status="00"==r?"poll card success!":"poll card fail!",mListener.onSearchMifareCardResult(y)}else if("0E"==mParas){"00"==(r=intToHexValue(getUpPBytes(t++,1)))?mListener.onFinishMifareCardResult(!0):mListener.onFinishMifareCardResult(!1)}}else"01"==mParas&&mListener.onSearchMifareCardResult(null),"0E"==mParas&&mListener.onFinishMifareCardResult(!1)}function getQPosInfo(){CommandDownlink(17,48,5);var e=getDownPBytes();void 0,startSession(new Uint8Array(e).buffer,onQposInfoResult,5)}function onQposInfoResult(e){void 0,0==getResult()?anlycPosInfo():void 0}function getQPosId(){CommandDownlink(16,0,5);var e=getDownPBytes();void 0,startSession(new Uint8Array(e).buffer,onQposIdResult,5)}function onQposIdResult(e){void 0,0==getResult()?anlycPosId():void 0}function setShutDownTime(e){if(!(65535<e)){CommandDownlink2(32,208,5,intToHex(e));var t=getDownPBytes();void 0,startSession(new Uint8Array(t).buffer,onSetShutDownTime,5)}}function onSetShutDownTime(e){void 0,0==getResult()?void 0:void 0}function getShutDownTime(){CommandDownlink(32,224,5);var e=getDownPBytes();void 0,startSession(new Uint8Array(e).buffer,onGetShutDownTime,5)}function onGetShutDownTime(e){if(void 0,0==getResult()){var t=byteArray2Hex(getUpPBytes(0,upPLength()));void 0}else void 0}function setSleepModeTime(e){if(!(4294967295<e)){var t=intToHex(e),r=new Array(4);switch(t.length){case 1:r[0]=0,r[1]=0,r[2]=0,r[3]=t[0];break;case 2:r[0]=0,r[1]=0,r[2]=t[0],r[3]=t[1];break;case 3:r[0]=0,r[1]=t[0],r[2]=t[1],r[3]=t[2];break;case 4:r=t}CommandDownlink2(34,112,5,r);var n=getDownPBytes();void 0,startSession(new Uint8Array(n).buffer,onSetSleepModeTime,5)}}function onSetSleepModeTime(e){void 0,0==getResult()?void 0:void 0}function getSleepModeTime(){CommandDownlink(34,128,10);var e=getDownPBytes();void 0,startSession(new Uint8Array(e).buffer,onGetSleepModeTime,5)}function onGetSleepModeTime(e){void 0,0==getResult()?void 0:void 0}GetMifareCardInfo.prototype.pollOnMifareCard=function(e){pollOnMifareCard(e)},GetMifareCardInfo.prototype.finishMifareCard=function(e){finishMifareCard(e)};var do_trade_timeout,mName,keyManager=function(e){writeObj(e),mListener=e,void 0,writeObj(this)},isLcdClosed=!1,isLcdshowing=!1,lcdShowCustomDisplayStr="",LcdModeAlign={LCD_MODE_ALIGNLEFT:1,LCD_MODE_ALIGNRIGHT:2,LCD_MODE_ALIGNCENTER:3},CustomInputOperateType={isNumber:1,Other:2},CustomInputDisplayType={PlainText:1,Other:2};function doInputCustomStr(e,t,r,n,o,a){mName=o;var s="0000";e==CustomInputOperateType.isNumber?s+="00":s+="01",e==CustomInputDisplayType.PlainText?s+="01":s+="00",s+=intToHexValue(r),s+=intToHexValue(n.length+1),s+=n,CommandDownlink2(16,192,a,hexStr2Bytes(s+="00"));var i=getDownPBytes();startSession(new Uint8Array(i).buffer,onReturnDoInputCustomStr,a)}function onReturnDoInputCustomStr(e){if(void 0,0==getResult()){var t=hexStr2Bytes(e.substring(18,e.length-2));void 0;var r=t[2];void 0;var n=byteArray2Hex(getBytesFromArr(3,r,t));void 0,mListener.onReturnDoInputCustomStr(hex2Ascii(n),mName)}else mListener.onReturnDoInputCustomStr(null,mName)}function lcdShowCustomDisplay(e,t,r){isLcdshowing&&lcdShowCloseDisplay(),isLcdClosed=!(isLcdshowing=!0),do_trade_timeout=r;var n="00";n=e==LcdModeAlign.LCD_MODE_ALIGNLEFT?"00":e==LcdModeAlign.LCD_MODE_ALIGNRIGHT?"20":e==LcdModeAlign.LCD_MODE_ALIGNCENTER?"40":"00",null==e&&(n="80");var o="";null!=t&&""!=t&&(o=n+t+"00");var a=hexStr2Bytes(lcdShowCustomDisplayStr=o);CommandDownlink2(65,16,do_trade_timeout,a);var s=getDownPBytes();startSession(new Uint8Array(s).buffer,onLcdShowCustomDisplay,do_trade_timeout)}function onLcdShowCustomDisplay(e){if(0==getResult()){for(var t=0;!isLcdClosed&&t<1e3*do_trade_timeout;)sleep(1),t++;isLcdshowing=!1,isLcdClosed||mListener.onLcdShowCustomDisplay(!0)}else mListener.onLcdShowCustomDisplay(!1)}function lcdShowCloseDisplay(){if(isLcdshowing){CommandDownlink2(65,16,1,hexStr2Bytes(lcdShowCustomDisplayStr=""));var e=getDownPBytes();isLcdshowing=!(isLcdClosed=!0),startSession(new Uint8Array(e).buffer,onLcdShowCustomDisplay,do_trade_timeout)}}function setMasterKey(e,t,r,n){if(!(10<r)){CommandDownlink2(16,226,n,hexStr2Bytes(e+t+"0"+r));var o=getDownPBytes();void 0,startSession(new Uint8Array(o).buffer,onSetMasterKeyResult,5)}}function onSetMasterKeyResult(e){void 0,0==getResult()?mListener.onReturnSetMasterKeyResult(!0):mListener.onReturnSetMasterKeyResult(!1)}function udpateWorkKey(e,t,r,n,o,a,s,i){if(!(10<=s)){CommandDownlink2(16,240,i,hexStr2Bytes(setWorkKeyStr(e,t,r,n,o,a,s)));var u=getDownPBytes();void 0,startSession(new Uint8Array(u).buffer,onUpdateWorkKeyResult,5)}}function setWorkKeyStr(e,t,r,n,o,a,s){var i="",u=0;isEmpty(e)||isEmpty(t)?t=e="":(u=e.length+t.length,u/=2),i+=toHex(u).substr(2,2)+e+t;var l=0;isEmpty(r)||isEmpty(n)?n=r="":(l=r.length+n.length,l/=2),i+=toHex(l).substr(2,2)+r+n;var y=0;return isEmpty(o)||isEmpty(a)?a=o="":(y=o.length+a.length,y/=2),i+=toHex(y).substr(2,2)+o+a,void 0,i+"0"+s}function onUpdateWorkKeyResult(e){void 0,0==getResult()?mListener.onRequestUpdateWorkKeyResult(!0):mListener.onRequestUpdateWorkKeyResult(!1)}function doUpdateIPEKOperation(e,t,r,n,o,a,s,i,u,l){if(!(10<=e)){CommandDownlink2(16,242,5,hexStr2Bytes("00000"+e+t+r+n+o+a+s+i+u+l));var y=getDownPBytes();void 0,startSession(new Uint8Array(y).buffer,onUpdateIPEKResult,5)}}function onUpdateIPEKResult(e){0==getResult()?mListener.onReturnUpdateIPEKResult(!0):mListener.onReturnUpdateIPEKResult(!1)}keyManager.prototype.setMasterKey=function(e,t,r,n){setMasterKey(e,t,r,n)},keyManager.prototype.udpateWorkKey=function(e,t,r,n,o,a,s,i){udpateWorkKey(e,t,r,n,o,a,s,i)},keyManager.prototype.udpateWorkKey=function(e,t,r,n,o,a,s,i){udpateWorkKey(e,t,r,n,o,a,s,i)},keyManager.prototype.doInputCustomStr=function(e,t,r,n,o,a){doInputCustomStr(e,t,r,n,o,a)},keyManager.prototype.lcdShowCustomDisplay=function(e,t,r){lcdShowCustomDisplay(e,t,r)},keyManager.prototype.lcdShowCloseDisplay=function(){lcdShowCloseDisplay()},keyManager.prototype.doUpdateIPEKOperation=function(e,t,r,n,o,a,s,i,u,l){doUpdateIPEKOperation(e,t,r,n,o,a,s,i,u,l)};var TCKEY=[0,0,0,0,0,0,0,0],dataLen=0,HEADER_LEN=4,CRC_LEN=1,OVERHEAD_LEN=5,DATA_FIELD_HEADER_LEN=5,bytes=new Array;function packet(e){e=OVERHEAD_LEN+DATA_FIELD_HEADER_LEN+(dataLen=e),(bytes=new Array(e))[1]=0;var t=intToHex(e-4);1==t.length?bytes[2]=t[0]:(bytes[1]=t[0],bytes[2]=t[1]),bytes[0]=77}function packet2(e){arrCopyArr(e,0,bytes=new Array(e.length),0,e.length),dataLen=e.length-(OVERHEAD_LEN+DATA_FIELD_HEADER_LEN),void 0}function setPByte(e,t){bytes[HEADER_LEN+e]=t}function getPByte(e){return e+HEADER_LEN<bytes.length?bytes[e+HEADER_LEN]:0}function getPBytes(){return bytes}function setCmdID(e){bytes[3]=e}function getCmdID(){return bytes[3]}function setCmdCode(e){setPByte(0,e)}function setCmdSubCode(e){setPByte(1,e)}function getCmdCode(){return getPByte(0)}function getCmdSubCode(){return getPByte(1)}function getResultCode(){return getPByte(2)}function setDataField(e){var t=e.length;setPByte(3,0);var r=intToHex(t);1==r.length?setPByte(4,r[0]):(setPByte(3,r[0]),setPByte(4,r[1])),arrCopyArr(e,0,bytes,HEADER_LEN+5,e.length)}function getDataFieldByte(e){return e+HEADER_LEN+5<bytes.length?bytes[e+HEADER_LEN+5]:0}function setTimeOut(e){setPByte(2,e)}function setPCRC(e){bytes[bytes.length-1]=e}function buildCRC(){setPCRC(calPCRC(bytes))}function getPCRC(){return bytes[bytes.length-1]}function calPCRC(e){for(var t=e[0],r=1;r<e.length-1;r++)t^=e[r];return void 0,t}function validPCRC(){return calPCRC(bytes)==getPCRC()}function isValid(){return 77==bytes[0]&&validPCRC()}function isPEmpty(){return 0==dataLen}function len(){return dataLen}function setDesKey(){if(8==KEY.length)arrCopyArr(KEY,0,TCKEY,0,8);else if(16==KEY.length){for(var e=new Array(8),t=0;t<8;t++)e[t]=byte(KEY[t]^KEY[t+8]);arrCopyArr(e,0,TCKEY,0,8),void 0}else void 0}function calMac(e,t){var r=t+1+(8-(t+1)%8),n=new Array(r);arrCopyArr(e,0,n,0,t);for(var o=t;o<r;o++)n[o]=0;var a=[0,0,0,0,0,0,0,0];for(o=0;o<r;o++)a[o%8]=a[o%8]^n[o];void 0;new Array;return void 0,a}var pinOperation=function(e){writeObj(e),mListener=e,void 0,writeObj(this)};function setInputCsutomStr(e,t,r,n,o){doGetPin(e,t,r,n,"","",0,o)}function getPin(e,t,r,n,o,a,s){doGetPin(e,t,r,n,o,a,0,s)}function doGetPin(e,t,r,n,o,a,s,i){var u="0000";u+=byteArray2Hex(intToHex(e))+byteArray2Hex(intToHex(t))+byteArray2Hex(intToHex(r));isEmpty(n)?(n="",u+=byteArray2Hex(intToHex(0))+n):u+=byteArray2Hex(intToHex(getUTF8Bytes(n).length+1))+byteArray2Hex(toGbkBytes(n))+"00";isEmpty(n)?(o="",u+=byteArray2Hex(intToHex(0))+o):u+=byteArray2Hex(intToHex(o.length))+byteArray2Hex(getUTF8Bytes(o));isEmpty(n)?(a="",u+=byteArray2Hex(intToHex(0))+a):u+=byteArray2Hex(intToHex(a.length/2))+a,CommandDownlink2(16,113,i,hexStr2Bytes(u+=byteArray2Hex(intToHex(s))));var l=getDownPBytes();void 0,startSession(new Uint8Array(l).buffer,onReturnGetPinResult,5)}function onReturnGetPinResult(e){if(void 0,0==getResult()){var t=new Array;upPLength();void 0;var r=2;byteArray2Hex(getUpPBytes(r,2));r+=2;var n=getUpPByte(r++),o=byteArray2Hex(getUpPBytes(r,n));r+=n;var a=getUpPByte(r++),s=byteArray2Hex(getUpPBytes(r,a));r+=a,t.push(o),t.push(s),mListener.onReturnGetPinResult(t),void 0}else mListener.onReturnGetPinResult(null),void 0}function pinKey_TDES(e,t,r,n){if(isEmpty(t))void 0;else{var o="0000";o+=byteArray2Hex(intToHex(e))+t,CommandDownlink2(17,32,r,hexStr2Bytes(o+=byteArray2Hex(intToHex(n))));var a=getDownPBytes();void 0,startSession(new Uint8Array(a).buffer,onPinKey_TDES_Result,5)}}function onPinKey_TDES_Result(e){if(void 0,0==getResult()){byteArray2Hex(getAllBytes());void 0}else void 0}pinOperation.prototype.setInputCsutomStr=function(e,t,r,n){setInputCsutomStr("0",e,t,r,n)};var READ_BUF_MAX_SIZE=10240,dataBuffer=new ArrayBuffer(READ_BUF_MAX_SIZE),dataView=new DataView(dataBuffer),read_offset=0;function clearReadbuffer(){for(var e=0;e<read_offset;e++)dataView.setUint8(e,0);read_offset=0}function appendData(e){for(var t=e,r=0;r<t.byteLength;r++)dataView.setUint8(read_offset,t.getUint8(r)),read_offset++}function readBufferData(){var e=new ArrayBuffer(read_offset),t=new DataView(e);return void 0,copyArr(dataBuffer,0,e,0,read_offset),t}function isCompleteInstruction(){var e=!1;if(77==dataView.getUint8(0)){var t=dataView.getUint8(1),r=dataView.getUint8(2);(t-t%16)/16*Math.pow(16,3)+t%16*Math.pow(16,2)+r+4<=read_offset&&(e=!0)}return e}var QPOSAnalyResult=function(e){writeObj(e),mListener=e,void 0,writeObj(this)};function onAnalyQposInfoResult(e){if(void 0,0==getResult()){var t=anlycPosInfo();writeObj(this),mListener.onQposInfoResult(t)}else void 0}function onAnalyQposIdResult(e){if(void 0,0==getResult()){var t=anlycPosId();mListener.onQposIdResult(t)}else void 0}QPOSAnalyResult.prototype.getQPosId=function(){CommandDownlink(16,0,5);var e=getDownPBytes();startSession(new Uint8Array(e).buffer,onAnalyQposIdResult,5)},QPOSAnalyResult.prototype.getQPosInfo=function(){CommandDownlink(17,48,5);var e=getDownPBytes();startSession(new Uint8Array(e).buffer,onAnalyQposInfoResult,5)},QPOSAnalyResult.prototype.checkCmdId=function(){return checkCmdId()};var Display={TRY_ANOTHER_INTERFACE:"TRY_ANOTHER_INTERFACE",PLEASE_WAIT:"PLEASE_WAIT",REMOVE_CARD:"REMOVE_CARD",CLEAR_DISPLAY_MSG:"CLEAR_DISPLAY_MSG",PROCESSING:"PROCESSING",PIN_OK:"PIN_OK",TRANSACTION_TERMINATED:"TRANSACTION_TERMINATED",INPUT_PIN_ING:"INPUT_PIN_ING",MAG_TO_ICC_TRADE:"MAG_TO_ICC_TRADE",INPUT_OFFLINE_PIN_ONLY:"INPUT_OFFLINE_PIN_ONLY",CARD_REMOVED:"CARD_REMOVED",INPUT_LAST_OFFLINE_PIN:"INPUT_LAST_OFFLINE_PIN",MSR_DATA_READY:"MSR_DATA_READY"};function checkCmdId(){var e=!1,t=commandID();return void 0,t==CmdId.CMDID_COMPLETED||t==CmdId.CMDID_COMPLETED_ENCRY?e=!0:t==CmdId.CMDID_INPUT_PIN_ING?(e=!0,!(0<upPLength())||0==getUpPByte(0)?mListener.onRequestDisplay(Display.INPUT_PIN_ING):mListener.onRequestDisplay(Display.INPUT_OFFLINE_PIN_ONLY)):t==CmdId.CMDID_MAG_TO_ICC_TRADE?(e=!0,mListener.onRequestDisplay(Display.MAG_TO_ICC_TRADE)):t==CmdId.CMDID_SEND_IC_CARDNO||t==CmdId.CMDID_EMV_KERNEL_PC||t==CmdId.CMDID_CHECK_HAVE_CARD?e=!0:t==CmdId.CMDID_MSR_DATA_READY?(e=!0,mListener.onRequestDisplay(Display.MSR_DATA_READY)):(e=!1,void 0,t==CmdId.CMDID_DESTRUCT?mListener.onRequestTransactionResult(TransactionResult.DEVICE_ERROR):t==CmdId.CMDID_TIMEOUT?mListener.onError(POSError.CMD_TIMEOUT):t==CmdId.CMDID_CARD_REMOVED?mListener.onRequestDisplay(Display.CARD_REMOVED):t==CmdId.CMDID_USERCANCEL?(mListener.onRequestDisplay(Display.TRANSACTION_TERMINATED),mListener.onRequestTransactionResult(TransactionResult.CANCEL)):t==CmdId.CMDID_MACERROR?mListener.onError(POSError.MAC_ERROR):t==CmdId.CMDID_EMV_TRANS_DENIAL?(mListener.onEmvICCExceptionData(byteArray2Hex(getUpPBytes(0,upPLength()))),mListener.onRequestTransactionResult(TransactionResult.DECLINED)):t==CmdId.CMDID_EMV_TRANS_TERMINATE?(mListener.onRequestDisplay(Display.TRANSACTION_TERMINATED),mListener.onEmvICCExceptionData(byteArray2Hex(getUpPBytes(0,upPLength()))),mListener.onRequestTransactionResult(TransactionResult.TERMINATED)):t==CmdId.CMDID_EMV_TRANS_TERMINATE_NFC?mListener.onRequestTransactionResult(TransactionResult.NFC_TERMINATED):t==CmdId.CMDID_NOT_AVAILABLE||t==CmdId.CMDID_OLD?mListener.onError(POSError.CMD_NOT_AVAILABLE):t==CmdId.CMDID_RESET?(e=!0,mListener.onError(POSError.DEVICE_RESET)):t==CmdId.CMDID_ICC_POWER_ON_ERROR?(void 0,mListener.onDoTradeResult(DoTradeResult.NOT_ICC,null)):t==CmdId.CMDID_WR_DATA_ERROR?mListener.onError(POSError.WR_DATA_ERROR):t==CmdId.CMDID_EMV_APP_CFG_ERROR?mListener.onError(POSError.EMV_APP_CFG_ERROR):t==CmdId.CMDID_EMV_CAPK_CFG_ERROR?mListener.onError(POSError.EMV_CAPK_CFG_ERROR):t==CmdId.CMDID_NO_UPDATE_WORK_KEY?mListener.onDoTradeResult(DoTradeResult.NO_UPDATE_WORK_KEY,null):t==CmdId.CMDID_EMV_TRANS_CARD_BLOCKED_OR_EMV_APPS?mListener.onRequestTransactionResult(TransactionResult.CARD_BLOCKED_OR_NO_EMV_APPS):t==CmdId.CMDID_EMV_TRANS_SELECT_APP_FAILED?mListener.onRequestTransactionResult(TransactionResult.SELECT_APP_FAIL):t==CmdId.CMDID_EMV_TRANS_CAPK_FAILED?mListener.onRequestTransactionResult(TransactionResult.CAPK_FAIL):t==CmdId.CMDID_EMV_TRANS_FALLBACK?mListener.onRequestTransactionResult(TransactionResult.FALLBACK):(t==CmdId.CMDID_ICC_INIT_ERROR?void 0:t==CmdId.CMDID_ICC_TRADE_ERROR?void 0:void 0,mListener.onError(POSError.UNKNOWN))),void 0,e}var POSError={TIMEOUT:"TIMEOUT",MAC_ERROR:"MAC_ERROR",CMD_TIMEOUT:"CMD_TIMEOUT",CMD_NOT_AVAILABLE:"CMD_NOT_AVAILABLE",DEVICE_RESET:"DEVICE_RESET",UNKNOWN:"UNKNOWN",DEVICE_BUSY:"DEVICE_BUSY",INPUT_OUT_OF_RANGE:"INPUT_OUT_OF_RANGE",INPUT_INVALID_FORMAT:"INPUT_INVALID_FORMAT",INPUT_ZERO_VALUES:"INPUT_ZERO_VALUES",INPUT_INVALID:"INPUT_INVALID",CASHBACK_NOT_SUPPORTED:"CASHBACK_NOT_SUPPORTED",CRC_ERROR:"CRC_ERROR",COMM_ERROR:"COMM_ERROR",WR_DATA_ERROR:"WR_DATA_ERROR",EMV_APP_CFG_ERROR:"EMV_APP_CFG_ERROR",EMV_CAPK_CFG_ERROR:"EMV_CAPK_CFG_ERROR",APDU_ERROR:"APDU_ERROR",APP_SELECT_TIMEOUT:"APP_SELECT_TIMEOUT",ICC_ONLINE_TIMEOUT:"ICC_ONLINE_TIMEOUT",AMOUNT_OUT_OF_LIMIT:"AMOUNT_OUT_OF_LIMIT"},DoTradeResult={NONE:"NONE",MCR:"MCR",ICC:"ICC",NOT_ICC:"NOT_ICC",BAD_SWIPE:"BAD_SWIPE",NO_RESPONSE:"NO_RESPONSE",NO_UPDATE_WORK_KEY:"NO_UPDATE_WORK_KEY",NFC_ONLINE:"NFC_ONLINE",NFC_OFFLINE:"NFC_OFFLINE",NFC_DECLINED:"NFC_DECLINED",TRY_ANOTHER_INTERFACE:"TRY_ANOTHER_INTERFACE"},QPOSService=function(){this.mOnResult,void 0,this.mDoTrade,this.mWebBluetooth,this.mEMVManager,this.writeChar,this.mKeyManager,this.mUpdateFirmware,this.mGtMifareCardInfo,this.mpinOperation};QPOSService.prototype.initListener=function(e){this.mOnResult=new QPOSAnalyResult(e),this.mDoTrade=new DoTrade(e),this.mWebBluetooth=new webBluetooth(this.mOnResult,this.writeChar),this.mEMVManager=new EMVManager(e),this.mKeyManager=new keyManager(e),this.mUpdateFirmware=new UpdateFirmwareManager(e),this.mGtMifareCardInfo=new GetMifareCardInfo(e),this.mpinOperation=new pinOperation(e)},QPOSService.prototype.getQPosInfo=function(){this.mOnResult.getQPosInfo()},QPOSService.prototype.getQPosId=function(){this.mOnResult.getQPosId()},QPOSService.prototype.doTrade=function(e,t){void 0,this.mDoTrade.doTrade(e,t)},QPOSService.prototype.sendPin=function(e){void 0,this.mDoTrade.sendPin(e)},QPOSService.prototype.doCheckCard=function(e,t){this.mDoTrade.doCheckCard(e,t)},QPOSService.prototype.selectEmvApp=function(e){this.mDoTrade.selectEmvApp(e)},QPOSService.prototype.sendOnlineProcessResult=function(e){this.mDoTrade.sendOnlineProcessResult(e)},QPOSService.prototype.getNFCBatchData=function(e,t){return this.mDoTrade.getNFCBatchData(e,t)},QPOSService.prototype.resetPosStatus=function(){this.mWebBluetooth.startSession(packageInstructionReset(),null,5)},QPOSService.prototype.updateEmvAPP=function(e,t){this.mEMVManager.updateEmvAPP(e,t)},QPOSService.prototype.updateEmvCAPK=function(e,t){this.mEMVManager.updateEmvCAPK(e,t)},QPOSService.prototype.updateEmvConfig=function(e,t){this.mEMVManager.updateEmvConfig(e,t)},QPOSService.prototype.getICCTag=function(e,t,r){return this.mDoTrade.getICCTag(e,t,r)},QPOSService.prototype.setMasterKey=function(e,t,r,n){this.mKeyManager.setMasterKey(e,t,r,n)},QPOSService.prototype.udpateWorkKey=function(e,t,r,n,o,a,s,i){this.mKeyManager.udpateWorkKey(e,t,r,n,o,a,s,i)},QPOSService.prototype.doUpdateIPEKOperation=function(e,t,r,n,o,a,s,i,u,l){this.mKeyManager.doUpdateIPEKOperation(e,t,r,n,o,a,s,i,u,l)},QPOSService.prototype.lcdShowCustomDisplay=function(e,t,r){this.mKeyManager.lcdShowCustomDisplay(e,t,r)},QPOSService.prototype.lcdShowCloseDisplay=function(){this.mKeyManager.lcdShowCloseDisplay()},QPOSService.prototype.doInputCustomStr=function(e,t,r,n,o,a){this.mKeyManager.doInputCustomStr(e,t,r,n,o,a)},QPOSService.prototype.pollOnMifareCard=function(e){this.mGtMifareCardInfo.pollOnMifareCard(e)},QPOSService.prototype.finishMifareCard=function(e){this.mGtMifareCardInfo.finishMifareCard(e)},QPOSService.prototype.setInputCsutomStr=function(e,t,r,n){this.mpinOperation.setInputCsutomStr(e,t,r,n)},QPOSService.prototype.updatePosFirmware=function(e){this.mUpdateFirmware.updatePosFirmware(e)};var connectionId,SerialManager=function(e){writeObj(e),mOnResult=e,void 0,writeObj(mOnResult)},onConnect=function(e){void 0===e||(chrome.serial.onReceive.addListener(onReceiveCallback),connectionId=e.connectionId)},onReceiveCallback=function(e){void 0,setNotifyReceiveData(!0);var t=e.data,r=new DataView(t);printDataView(r),appendData(r)};function connectToDevice(e){chrome.serial.connect(e,{bitrate:9600},onConnect)}function disconnectToDevice(e){chrome.serial.disconnect(connectionId,e)}var notifyReceiveData=!1;function setNotifyReceiveData(e){notifyReceiveData=e}function getNotifyReceiveData(){return notifyReceiveData}var mUpdateFlag=!1;function setUpdate(e){mUpdateFlag=e}function packageInstructionQue(){CommandDownlink4(CmdId.CMDID_QUERY,0,0,90);var e=getDownPBytes();return void 0,new Uint8Array(e).buffer}function packageInstructionPart(){CommandDownlink4(CmdId.CMDID_PART_DATA,0,0,90);var e=getDownPBytes();return void 0,new Uint8Array(e).buffer}function packageInstructionReset(){CommandDownlink4(CmdId.CMDID_RESET,0,0,15);var e=getDownPBytes();return void 0,new Uint8Array(e).buffer}function basicWriteBle(e){chrome.serial.send(connectionId,e,console.log.bind(console))}function writePromise(e){setNotifyReceiveData(!1);var t=e;void 0,clearReadbuffer(),basicWriteBle(t),void 0}SerialManager.prototype.startSession=function(e,t,r){startSession(e,t,r)};var bufData="",bufLen=0,result=null;function startSession(e,t,r){function n(){readBleDataBuffer(t,--r,n)}r*=100,result=null,writePromise(e),void 0,readBleDataBuffer(t,r,n)}function readBleDataBuffer(o,a,s){setTimeout(function(){if(a<=0)return initPartBuffer(),void void 0;if(getNotifyReceiveData()){var e=readBufferData();if(null==e)return initPartBuffer(),void void 0;if(printDataView(e),!isCompleteInstruction())return void 0,void s();var t=dataView2Hex(e);if("24"!=t.substring(6,8))"36"==t.substring(6,8)?(bufLen=parseInt(t.substring(14,18),16),bufData+=t.substring(18,18+2*bufLen),void 0,startSession(packageInstructionPart(),o,90)):"23"==t.substring(6,8)||"41"==t.substring(6,8)||"43"==t.substring(6,8)||"42"==t.substring(6,8)||"52"==t.substring(6,8)?(startSession(packageInstructionQue(),o,90),void 0):(packet2(hexStr2Bytes(t)),mOnResult.checkCmdId());else{if(void 0,0!=bufLen){var r=parseInt(t.substring(14,18),16),n=t.substring(8,18)+bufData+t.substring(18,18+2*r);void 0,packageCommandUplink(n)}else void 0,packet2(hexStr2Bytes(t));if(void 0,initPartBuffer(),validPCRC()){if(!mOnResult.checkCmdId())return;null!=o?o(byteArray2Hex(getAllBytes())):result=byteArray2Hex(getAllBytes())}}}else s()},10)}function initPartBuffer(){bufData="",bufLen=0}function startSysSession(n,o,a){return new Promise(function(e,t){function r(){readSysBleDataBuffer(o,--a,r,e,t)}result=null,writePromise(n),a*=100,void 0,readSysBleDataBuffer(o,a,r,e,t)})}function readSysBleDataBuffer(l,e,y,c,d){setTimeout(function(){if(n<=0)return initPartBuffer(),void d("time out");if(getNotifyReceiveData()){var e=readBufferData();if(null==e)return initPartBuffer(),void d("onError(Error.UNKNOWN)");if(printDataView(e),isCompleteInstruction()&&!mUpdateFlag){var t=dataView2Hex(e);if("24"!=t.substring(6,8))if("36"==t.substring(6,8)){var r=function e(){readSysBleDataBuffer(l,--n,e,c,d)};bufLen=parseInt(t.substring(14,18),16),bufData+=t.substring(18,18+2*bufLen),void 0,result=null,writePromise(packageInstructionPart());var n=500;void 0,readSysBleDataBuffer(l,n,r,c,d)}else if("23"==t.substring(6,8)||"41"==t.substring(6,8)||"43"==t.substring(6,8)||"42"==t.substring(6,8)||"52"==t.substring(6,8)){var o=function e(){readSysBleDataBuffer(l,--n,e,c,d)};result=null,writePromise(packageInstructionQue());n=500;void 0,readSysBleDataBuffer(l,n,o,c,d),void 0}else packet2(hexStr2Bytes(t)),mOnResult.checkCmdId();else{if(void 0,0!=bufLen){var a=parseInt(t.substring(14,18),16),s=t.substring(8,18)+bufData+t.substring(18,18+2*a);void 0,packageCommandUplink(s)}else void 0,packet2(hexStr2Bytes(t));if(void 0,initPartBuffer(),validPCRC()){if(!mOnResult.checkCmdId())return void d("data verify error");null!=l?(void 0,l(byteArray2Hex(getAllBytes()))):(void 0,result=byteArray2Hex(getAllBytes()),c(result))}}}else if(mUpdateFlag){for(var i=new Array(e.byteLength),u=0;u<e.byteLength;u++)i[u]=e.getUint8(u);e.getUint8(11)==calPCRC(i)&&(null!=l?l(t):c(result=t))}else void 0,y()}else y()},10)}SerialManager.prototype.startSysSession=function(e,t,r){return startSysSession(e,t,r)};var mListener,UpdateFirmwareManager=function(e){writeObj(e),mListener=e,void 0,writeObj(this)};function updatePosFirmware(A){CommandDownlink(17,48,5);var e=getDownPBytes();void 0,startSysSession(new Uint8Array(e).buffer,null,5).then(function(e){if(0==getResult()){var t=0,r=getUpPByte(t++),n=byteArray2Hex(getUpPBytes(t,r));n=hex2Ascii(n),t+=r;var o=getUpPByte(t++),a=byteArray2Hex(getUpPBytes(t,o));a=hex2Ascii(a),t+=o;var s=getUpPByte(t++),i=byteArray2Hex(getUpPBytes(t,s));i=hex2Ascii(i),t+=s;var u=getUpPByte(t++);void 0;byteArrayToInt(getUpPBytes(t,u));t+=u;var l=getUpPByte(t++),y=byteArray2Hex(getUpPBytes(t,l));y="00"==y?"false":"true",t+=l;var c=getUpPByte(t++),d=byteArray2Hex(getUpPBytes(t,c));d="00"==d?"false":"true",t+=c,0!=y.search("true")&&0!=d.search("true")||(void 0,setUpdateData(A),void 0,startUpdateFirmware())}},function(e){void 0,setUpdateData(A),startUpdateFirmware()})}UpdateFirmwareManager.prototype.updatePosFirmware=function(e){updatePosFirmware(e)};var upgPack_totalLen,g_UpgPackDataLen=0,g_UpgPackData=new Array,g_UpgPackDataIndex=0;function setUpdateData(e){var t=hexStr2Bytes(e),r=t.length-32;arrCopyArr(t,32,g_UpgPackData=new Array(r),0,r),g_UpgPackDataLen=upgPack_totalLen=r,void 0,g_UpgPackDataIndex=0}function startUpdateFirmware(){if(0!=g_UpgPackDataLen){void 0;var e=g_UpgPackData[g_UpgPackDataIndex],t=new Array(2);t[0]=g_UpgPackData[g_UpgPackDataIndex+1],t[1]=g_UpgPackData[g_UpgPackDataIndex+2];var r=byteArrayToInt(t),n=new Array(r);switch(arrCopyArr(g_UpgPackData,g_UpgPackDataIndex+3,n,0,r),void 0,g_UpgPackDataIndex+=r+3,g_UpgPackDataLen-=r+3,void 0,e){case 2:doWorkbyT0x02(n);break;case 3:doWorkbyT0x03();break;case 4:doWorkbyT0x04();break;case 17:void 0,setTimeout(function(){void 0,writePromise(new Uint8Array(n).buffer),startUpdateFirmware()},100);break;case 18:doWorkbyT0x12(n)}}else void 0}function doWorkbyT0x02(e){var t=byteArrayToInt(e);t*=2,void 0,setTimeout(function(){void 0,startUpdateFirmware()},1e3*t)}var conCou=0;function doWorkbyT0x03(){void 0,openAndConnectDevice().then(function(e){void 0,startUpdateFirmware()},function(e){void 0,void 0,++conCou<3&&setTimeout(function(){doWorkbyT0x03()},500)})}function doWorkbyT0x04(){void 0,closeAndConnectDevice(function(){startUpdateFirmware()})}function doWorkbyT0x11(e){setUpdate(!0),startSysSession(new Uint8Array(e).buffer,null,5).then(function(e){var t=hexStr2Bytes(e);if(0==t.length||0!=t[6])return void 0,void setUpdate(!1);setUpdate(!1),startUpdateFirmware()},function(e){setUpdate(!1),void 0,void 0,startUpdateFirmware()})}function doWorkbyT0x12(e){startSysSession(new Uint8Array(e).buffer,null,5).then(function(e){0==getResult()&&(commandID()==CmdId.CMDID_CRCERROR&&void 0,startUpdateFirmware())},function(e){void 0,void 0})}function uuidFormat(e){if(null!=e)return"0x"+e.substring(4,13).toUpperCase()}function writeObj(e){for(var t in e){e[t]}}function hexStr2Bytes(e){e.includes("0x")&&(e=e.replace("0x",""));var t=0;if(""==e)return new Array;var r=e.length;if(r%2!=0)return null;r/=2;for(var n=new Array,o=0;o<r;o++){var a=e.substr(t,2),s=parseInt(a,16);n.push(s),t+=2}return n}function byteArray2Hex(e){return Array.prototype.map.call(new Uint8Array(e),function(e){return("00"+e.toString(16)).slice(-2)}).join("")}function stringToBytes(e){for(var t,r,n=[],o=0;o<e.length;o++){for(t=e.charCodeAt(o),r=[];r.push(255&t),t>>=8;);n=n.concat(r.reverse())}return n}function sleep(e){for(var t=new Date,r=t.getTime()+e;;)if((t=new Date).getTime()>r)return}function printDataView(e){for(var t=new Uint8Array(e.byteLength),r=0;r<e.byteLength;r++)t[r]=e.getUint8(r);var n=byteArray2Hex(t);void 0}function dataView2Hex(e){for(var t=new Uint8Array(e.byteLength),r=0;r<e.byteLength;r++)t[r]=e.getUint8(r);return byteArray2Hex(t)}function arrCopyArr(e,t,r,n,o){for(var a=t;a<t+o;a++)r[n]=e[a],n++;return r}function toHex(e){return e<16?"0x0"+e.toString(16).toUpperCase():"0x"+e.toString(16).toUpperCase()}function calCRC(e){for(var t=e[0],r=1;r<e.length;r++)t^=e[r];return void 0,t}function copyArr(e,t,r,n,o){for(var a=n,s=new DataView(r),i=t+o,u=new DataView(e),l=t;l<i;l++){var y=u.getUint8(l);s.setUint8(a,y),a++}return r}function getBytesFromArr(e,t,r){return r.slice(e,e+t)}function ab2str(e){return String.fromCharCode.apply(null,new Uint16Array(e))}function byteArrayToInt(e){for(var t=0,r=0;r<e.length;r++)t<<=8,t|=255&e[r];return t}function Str2Bytes(e){var t=0;if(""==e)return new Array;var r=e.length;if(r%2!=0)return null;r/=2;for(var n=new Array,o=0;o<r;o++){var a=e.substr(t,2),s=parseInt(a,16);n.push(s),t+=2}return n}function intToHex(e){var t;return(t=!(0<=e&&e<16)&&16<=e&&e<256?e.toString(16):"0"+e.toString(16)).length%2!=0&&"0"==t.charAt(0)&&(t=t.substring(1)),Str2Bytes(t)}function intToHexValue(e){return!(0<=e&&e<16)&&16<=e&&e<256?e.toString(16):"0"+e.toString(16)}var CLICKTAG=0;function button_onclick(e){0==CLICKTAG&&(CLICKTAG=1,e.disabled=!0,setTimeout(function(){CLICKTAG=0,e.disabled=!1},3e3))}function getDate(){var e=new Date,t=e.getFullYear(),r=e.getMonth()+1,n=e.getDate(),o=e.getHours(),a=e.getMinutes(),s=e.getSeconds();return t+"-"+conver(r)+"-"+conver(n)+" "+conver(o)+":"+conver(a)+":"+conver(s)}function conver(e){return e<10?"0"+e:e}var writeChar,mOnResult,symbols=" !\"#$%&'()*+,-./0123456789:;<=>?@",loAZ="abcdefghijklmnopqrstuvwxyz";function hex2Ascii(e){var t=e.toLowerCase(),r="0123456789abcdef",n="",o=0;for(o=0;o<t.length;o+=2){var a=t.charAt(o);":"==a&&(o++,a=t.charAt(o));var s=t.charAt(o+1),i=r.indexOf(a)<<4;i|=r.indexOf(s);var u=parseInt(i)-32,l="?";0<=u&&i<=126&&(l=symbols.charAt(u)),n+=l}return n}function isEmpty(e){return null==e||void 0===e||""==e.trime}function getFormatDateyyyyMMddHHmmss(){var e=new Date;return e.getFullYear().toString()+conver(e.getMonth()+1)+conver(e.getDate())+conver(e.getHours())+conver(e.getMinutes())+conver(e.getSeconds())}function getUTF8Bytes(e){for(var t=[],r=e.length,n=0;n<r;++n){var o=e.charCodeAt(n);65536<=o&&o<=1114111?(t.push(o>>18|240),t.push(o>>12&63|128),t.push(o>>6&63|128),t.push(63&o|128)):2048<=o&&o<=65535?(t.push(o>>12|224),t.push(o>>6&63|128),t.push(63&o|128)):128<=o&&o<=2047?(t.push(o>>6|192),t.push(63&o|128)):t.push(o)}return t}function toGbkBytes(e){for(var t=new Array,r=0;r<e.length;r++){var n=e.charAt(r);if("%"==n){var o=e.charAt(r+1)+e.charAt(r+2);o=parseInt(o,16),o|=-256,t.push(o),r+=2}else t.push(n.charCodeAt())}return t}symbols+=loAZ.toUpperCase(),symbols+="[\\]^_`",symbols+=loAZ,symbols+="{|}~";var webBluetooth=function(e,t){writeObj(e),this.mOnResult=e,this.writeChar=t,writeObj(mOnResult)};function registNotify(e){e.startNotifications().then(function(e){void 0}).catch(function(e){void 0}),basicReadBle(e)}webBluetooth.prototype.startSession=function(e,t,r){startSession(e,t,r)};bufData="",bufLen=0,result=null;function startSession(e,t,r){r*=100,result=null,writePromise(e),void 0,readBleDataBuffer(t,r,function e(){readBleDataBuffer(t,--r,e)})}function basicReadBle(e){e.addEventListener("characteristicvaluechanged",function(e){void 0,setNotifyReceiveData(!0);var t=e.target.value;printDataView(t),appendData(t)}),e.startNotifications()}var write_Max_len=16;notifyReceiveData=!1;function setNotifyReceiveData(e){notifyReceiveData=e}function getNotifyReceiveData(){return notifyReceiveData}function basicWriteBle(e,t,r){writeChar.writeValue(e).then(function(){null!=t&&null!=t&&void 0},function(e){null!=r&&null!=r&&void 0})}function writePromise(e){setNotifyReceiveData(!1);var t=e;void 0,clearReadbuffer();var r=t.byteLength;if(r<=write_Max_len){void 0,basicWriteBle(t,function(){void 0},function(e){void 0})}else{var n,o=-1,a=0;a=r%write_Max_len==0?r/write_Max_len:(r-(o=r%write_Max_len))/write_Max_len+1;for(var s=write_Max_len,i=0,u=new Array;0<a;)s=-1!=o&&1==a?o:write_Max_len,n=new ArrayBuffer(s),copyArr(t,i*write_Max_len,n,0,s),u[i]=n,void 0,a--,i++;writePromiseCou=0,basicMultisessionBle(u,function(){void 0},function(e){void 0})}void 0}var writePromiseCou=0;function basicMultisessionBle(e,t,r){writePromiseCou>=e.length||(writeChar.writeValue(e[writePromiseCou]).then(function(){null!=t&&null!=t&&basicMultisessionBle(e,t,r)},function(){}),writePromiseCou++)}function startSysSession(e,n,o){return new Promise(function(t,r){result=null,writePromise(e),o*=100,void 0,readSysBleDataBuffer(n,o,function e(){readSysBleDataBuffer(n,--o,e,t,r)},t,r)})}mUpdateFlag=!1;function setUpdate(e){mUpdateFlag=e}function packageInstructionQue(){CommandDownlink4(CmdId.CMDID_QUERY,0,0,90);var e=getDownPBytes();return void 0,new Uint8Array(e).buffer}function packageInstructionPart(){CommandDownlink4(CmdId.CMDID_PART_DATA,0,0,90);var e=getDownPBytes();return void 0,new Uint8Array(e).buffer}function packageInstructionReset(){CommandDownlink4(CmdId.CMDID_RESET,0,0,15);var e=getDownPBytes();return void 0,new Uint8Array(e).buffer}function readBleDataBuffer(o,a,s){setTimeout(function(){if(a<=0)return initPartBuffer(),void void 0;if(getNotifyReceiveData()){var e=readBufferData();if(null==e)return initPartBuffer(),void void 0;if(isCompleteInstruction()){var t=dataView2Hex(e);if("24"!=t.substring(6,8))"36"==t.substring(6,8)?(bufLen=parseInt(t.substring(14,18),16),bufData+=t.substring(18,18+2*bufLen),void 0,startSession(packageInstructionPart(),o,90)):"23"==t.substring(6,8)||"41"==t.substring(6,8)||"43"==t.substring(6,8)||"42"==t.substring(6,8)||"52"==t.substring(6,8)?(startSession(packageInstructionQue(),o,90),void 0):(packet2(hexStr2Bytes(t)),mOnResult.checkCmdId());else{if(void 0,0!=bufLen){var r=parseInt(t.substring(14,18),16),n=t.substring(8,18)+bufData+t.substring(18,18+2*r);void 0,packageCommandUplink(n)}else void 0,packet2(hexStr2Bytes(t));if(void 0,initPartBuffer(),validPCRC()){if(!mOnResult.checkCmdId())return;null!=o?o(byteArray2Hex(getAllBytes())):result=byteArray2Hex(getAllBytes())}}}else s()}else s()},10)}function initPartBuffer(){bufData="",bufLen=0}function readSysBleDataBuffer(i,e,u,l,y){setTimeout(function(){if(r<=0)return initPartBuffer(),void y("time out");if(getNotifyReceiveData()){var e=readBufferData();if(null==e)return initPartBuffer(),void y("onError(Error.UNKNOWN)");if(isCompleteInstruction()&&!mUpdateFlag){var t=dataView2Hex(e);if("24"!=t.substring(6,8))if("36"==t.substring(6,8)){bufLen=parseInt(t.substring(14,18),16),bufData+=t.substring(18,18+2*bufLen),void 0,result=null,writePromise(packageInstructionPart());var r=500;void 0,readSysBleDataBuffer(i,r,function e(){readSysBleDataBuffer(i,--r,e,l,y)},l,y)}else if("23"==t.substring(6,8)||"41"==t.substring(6,8)||"43"==t.substring(6,8)||"42"==t.substring(6,8)||"52"==t.substring(6,8)){result=null,writePromise(packageInstructionQue());r=500;void 0,readSysBleDataBuffer(i,r,function e(){readSysBleDataBuffer(i,--r,e,l,y)},l,y),void 0}else packet2(hexStr2Bytes(t)),mOnResult.checkCmdId();else{if(void 0,0!=bufLen){var n=parseInt(t.substring(14,18),16),o=t.substring(8,18)+bufData+t.substring(18,18+2*n);void 0,packageCommandUplink(o)}else void 0,packet2(hexStr2Bytes(t));if(void 0,initPartBuffer(),validPCRC()){if(!mOnResult.checkCmdId())return void y("data verify error");null!=i?(void 0,i(byteArray2Hex(getAllBytes()))):(void 0,result=byteArray2Hex(getAllBytes()),l(result))}}}else if(mUpdateFlag){for(var a=new Array(e.byteLength),s=0;s<e.byteLength;s++)a[s]=e.getUint8(s);e.getUint8(11)==calPCRC(a)&&(null!=i?i(t):l(result=t))}else void 0,u()}else u()},10)}
