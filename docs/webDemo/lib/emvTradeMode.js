function setMasterKey(key,checkValue,keyIndex,timeout){if(keyIndex>10){return}var paras=key+checkValue+"0"+keyIndex;CommandDownlink2(16,226,timeout,hexStr2Bytes(paras));var datas=getDownPBytes();console.log(byteArray2Hex(datas));startSession(new Uint8Array(datas).buffer,onReturnSetMasterKeyResult,5)}function onReturnSetMasterKeyResult(receivedData){console.log("onReturnSetMasterKeyResult----------"+receivedData+"commid----------"+receivedData.substring(6,8));if(getResult()==0){console.log("onReturnSetMasterKeyResult"+true)}else{console.log("onReturnSetMasterKeyResult"+false)}}function udpateWorkKey(pik,pikCheck,trk,trkCheck,mak,makCheck,keyIndex,timeout){if(keyIndex>=10){return}var paras=setWorkKeyStr(pik,pikCheck,trk,trkCheck,mak,makCheck,keyIndex);CommandDownlink2(16,240,timeout,hexStr2Bytes(paras));var datas=getDownPBytes();console.log(byteArray2Hex(datas));startSession(new Uint8Array(datas).buffer,onRequestUpdateWorkKeyResult,5)}function setWorkKeyStr(pik,pikCheck,trk,trkCheck,mak,makCheck,keyIndex){var str="";var pikkLen=0;if(!isEmpty(pik)&&!isEmpty(pikCheck)){pikkLen=pik.length+pikCheck.length;pikkLen=pikkLen/2}else{pik="";pikCheck=""}str+=toHex(pikkLen).substr(2,2)+pik+pikCheck;var trkLen=0;if(!isEmpty(trk)&&!isEmpty(trkCheck)){trkLen=trk.length+trkCheck.length;trkLen=trkLen/2}else{trk="";trkCheck=""}str+=toHex(trkLen).substr(2,2)+trk+trkCheck;var makLen=0;if(!isEmpty(mak)&&!isEmpty(makCheck)){makLen=mak.length+makCheck.length;makLen=makLen/2}else{mak="";makCheck=""}str+=toHex(makLen).substr(2,2)+mak+makCheck;console.log("work keys: "+str);return str+"0"+keyIndex}function onRequestUpdateWorkKeyResult(receivedData){console.log("onRequestUpdateWorkKeyResult----------"+receivedData+"commid----------"+receivedData.substring(6,8));if(getResult()==0){console.log("onRequestUpdateWorkKeyResult"+true)}else{console.log("onRequestUpdateWorkKeyResult"+false)}}function doUpdateIPEKOperation(ipekgroup,trackksn,trackipek,trackipekCheckvalue,emvksn,emvipek,emvipekCheckvalue,pinksn,pinipek,pinipekCheckvalue){if(ipekgroup>=10){return
}var paras="0000"+"0"+ipekgroup+trackksn+trackipek+trackipekCheckvalue+emvksn+emvipek+emvipekCheckvalue+pinksn+pinipek+pinipekCheckvalue;CommandDownlink2(16,242,5,hexStr2Bytes(paras));var datas=getDownPBytes();console.log(byteArray2Hex(datas));startSession(new Uint8Array(datas).buffer,onReturnUpdateIPEKResult,5)}function onReturnUpdateIPEKResult(receivedData){console.log("onReturnUpdateIPEKResult----------"+receivedData+"commid----------"+receivedData.substring(6,8));if(getResult()==0){console.log("onReturnUpdateIPEKResult"+true)}else{console.log("onReturnUpdateIPEKResult"+false)}};
function getPin(encryptType,keyIndex,maxLen,typeFace,cardNo,data,waitPinTime,timeout){doGetPin(encryptType,keyIndex,maxLen,typeFace,cardNo,data,waitPinTime,timeout)}function getPin(encryptType,keyIndex,maxLen,typeFace,cardNo,data,timeout){doGetPin(encryptType,keyIndex,maxLen,typeFace,cardNo,data,0,timeout)}function doGetPin(encryptType,keyIndex,maxLen,typeFace,cardNo,data,waitPinTime,timeout){var str="0000";str+=byteArray2Hex(intToHex(encryptType))+byteArray2Hex(intToHex(keyIndex))+byteArray2Hex(intToHex(maxLen));var typeFaceLen=0;if(!isEmpty(typeFace)){typeFaceLen=getUTF8Bytes(typeFace).length+1;str+=byteArray2Hex(intToHex(typeFaceLen))+byteArray2Hex(toGbkBytes(typeFace))+"00"}else{typeFaceLen=0;typeFace="";str+=byteArray2Hex(intToHex(typeFaceLen))+typeFace}var cardNoLen=0;if(!isEmpty(typeFace)){cardNoLen=cardNo.length;str+=byteArray2Hex(intToHex(cardNoLen))+byteArray2Hex(getUTF8Bytes(cardNo))}else{cardNoLen=0;cardNo="";str+=byteArray2Hex(intToHex(cardNoLen))+cardNo}var dataLen=0;if(!isEmpty(typeFace)){dataLen=data.length/2;str+=byteArray2Hex(intToHex(dataLen))+data}else{dataLen=0;data="";str+=byteArray2Hex(intToHex(dataLen))+data}str+=byteArray2Hex(intToHex(waitPinTime));var paras=str;CommandDownlink2(16,113,timeout,hexStr2Bytes(paras));var datas=getDownPBytes();console.log(byteArray2Hex(datas));startSession(new Uint8Array(datas).buffer,onReturnGetPinResult,5)}function onReturnGetPinResult(receivedData){console.log("onReturnGetPinResult----------"+receivedData+"commid----------"+receivedData.substring(6,8));if(getResult()==0){var hashtable=new Array();var countLen=upPLength();console.log(" length()--"+upPLength());var index=2;var en_mode=byteArray2Hex(getUpPBytes(index,2));index+=2;var pinKsnLen=getUpPByte(index++);var pinKsn=byteArray2Hex(getUpPBytes(index,pinKsnLen));index+=pinKsnLen;var pinBlockLen=getUpPByte(index++);var pinBlock=byteArray2Hex(getUpPBytes(index,pinBlockLen));index+=pinBlockLen;hashtable.push(pinKsn);hashtable.push(pinBlock);console.log("onReturnGetPinResult"+hashtable)
}else{console.log("onReturnGetPinResult"+"error")}}function pinKey_TDES(key_index,pin,timeout,format){if(isEmpty(pin)){console.log("onError(Error.INPUT_INVALID_FORMAT");return}var str="0000";str+=byteArray2Hex(intToHex(key_index))+pin;str+=byteArray2Hex(intToHex(format));var paras=str;CommandDownlink2(17,32,timeout,hexStr2Bytes(paras));var datas=getDownPBytes();console.log(byteArray2Hex(datas));startSession(new Uint8Array(datas).buffer,onPinKey_TDES_Result,5)}function onPinKey_TDES_Result(receivedData){console.log("onPinKey_TDES_Result----------"+receivedData+"commid----------"+receivedData.substring(6,8));if(getResult()==0){var result=byteArray2Hex(getAllBytes());console.log("esc.onPinKey_TDES_Result(result);"+"result")}else{console.log("onPinKey_TDES_Result"+"error")}};
var TransactionType={};TransactionType.GOODS=0;TransactionType.SERVICES=1;TransactionType.CASH=2;TransactionType.CASHBACK=3;TransactionType.INQUIRY=4;TransactionType.TRANSFER=5;TransactionType.ADMIN=6;TransactionType.CASHDEPOSIT=7;TransactionType.PAYMENT=8;TransactionType.PBOCLOG=9;TransactionType.SALE=10;TransactionType.PREAUTH=11;TransactionType.ADMIN=12;TransactionType.ECQ_DESIGNATED_LOAD=13;TransactionType.ECQ_UNDESIGNATED_LOAD=14;TransactionType.ECQ_CASH_LOAD=15;TransactionType.ECQ_CASH_LOAD_VOID=16;TransactionType.ECQ_INQUIRE_LOG=17;TransactionType.REFUND=18;TransactionType.UPDATE_PIN=19;
var EMVDataOperation={};EMVDataOperation.CLEAR=0;EMVDataOperation.ADD=1;EMVDataOperation.DELETE=2;EMVDataOperation.ATTAINLIST=3;EMVDataOperation.UPDATE=4;EMVDataOperation.GETEMV=5;
var EMVManager=function(listener){writeObj(listener);mListener=listener;console.log("EMVManager init"+mListener);writeObj(this)};var mListener;EMVManager.prototype.updateEmvAPP=function(operationType,appTLV){updateEmvAPP(operationType,appTLV)};EMVManager.prototype.updateEmvCAPK=function(operationType,capkTLV){updateEmvCAPK(operationType,capkTLV)};EMVManager.prototype.updateEmvConfig=function(emvAppCfg,emvCapkCfg){updateEmvConfig(emvAppCfg,emvCapkCfg)};var mOperationType;var WRITE_MAX_LEN=100;function updateEmvAPP(operationType,appTLV){if(operationType==null||operationType==undefined){return}if(isEmpty(appTLV)){appTLV=""}mOperationType=operationType;var paras=updateEMV(operationType,appTLV);CommandDownlink2(23,162,15,hexStr2Bytes(paras));var datas=getDownPBytes();console.log(byteArray2Hex(datas));startSession(new Uint8Array(datas).buffer,onReturnUpdateEmvAPPResult,5)}function updateEMV(operationType,data){var p="";switch(operationType){case EMVDataOperation.CLEAR:p="01";break;case EMVDataOperation.ADD:p="02"+data;break;case EMVDataOperation.DELETE:p="03"+data;break;case EMVDataOperation.ATTAINLIST:p="04";break;case EMVDataOperation.UPDATE:p="05"+data;break;case EMVDataOperation.GETEMV:p="06"+data;break}return p}function onReturnUpdateEmvAPPResult(receivedData){console.log("onReturnUpdateEmvAPPResult----------"+receivedData+"commid----------"+receivedData.substring(6,8));if(getResult()==0){if(mOperationType==EMVDataOperation.ATTAINLIST){var aidString=byteArray2Hex(getUpPBytes(0,upPLength()));var numLen=0;var num=aidString.substring(0,2);for(var i=0;i<aidString.length;i++){if(aidString.search("1000000000000000000000000000000000")==1){numLen=parseInt(num,16)-1;aidString=aidString.replace("1000000000000000000000000000000000","");if(numLen<17){num="0"+toHex(numLen).substr(2,2).toUpperCase()}else{num=toHex(numLen).substr(2,2).toUpperCase()}}}aidString=num+aidString.slice(2);console.log("onReturnUpdateEmvAPPResult"+aidString);mListener.onReturnGetEMVListResult(aidString)}else{if(mOperationType==EMVDataOperation.GETEMV){var aidEmvData=byteArray2Hex(getUpPBytes(0,upPLength()));
console.log("onReturnUpdateEmvAPPResult"+aidEmvData);mListener.onReturnGetEMVListResult(aidEmvData)}else{console.log("onReturnUpdateEmvAPPResult"+true);mListener.onReturnUpdateEMVResult(true)}}}else{console.log("onReturnUpdateEmvAPPResult"+false);mListener.onReturnUpdateEMVResult(false)}mOperationType=null}function updateEmvCAPK(operationType,capkTLV){if(operationType==null||operationType==undefined||operationType==EMVDataOperation.UPDATE){return}if(isEmpty(capkTLV)){capkTLV=""}mOperationType=operationType;var paras=updateEMV(operationType,capkTLV);CommandDownlink2(23,161,15,hexStr2Bytes(paras));var datas=getDownPBytes();console.log(byteArray2Hex(datas));startSession(new Uint8Array(datas).buffer,onReturnUpdateEmvCAPKResult,5)}function onReturnUpdateEmvCAPKResult(receivedData){console.log("onReturnUpdateEmvCAPKResult----------"+receivedData+"commid----------"+receivedData.substring(6,8));if(getResult()==0){if(mOperationType==EMVDataOperation.ATTAINLIST){var aidString=byteArray2Hex(getUpPBytes(0,upPLength()));var numLen=0;var num=aidString.substring(0,2);for(var i=0;i<aidString.length;i++){if(aidString.search("1000000000000000000000000000000000")==1){numLen=parseInt(num,16)-1;aidString=aidString.replace("1000000000000000000000000000000000","");if(numLen<17){num="0"+toHex(numLen).substr(2,2).toUpperCase()}else{num=toHex(numLen).substr(2,2).toUpperCase()}}}aidString=num+aidString.slice(2);console.log("onReturnUpdateEmvCAPKResult"+aidString);mListener.onReturnGetEMVListResult(aidString)}else{if(mOperationType==EMVDataOperation.GETEMV){var aidEmvData=byteArray2Hex(getUpPBytes(0,upPLength()));console.log("onReturnUpdateEmvCAPKResult"+aidEmvData);mListener.onReturnGetEMVListResult(aidEmvData)}else{console.log("onReturnUpdateEmvCAPKResult"+true);mListener.onReturnUpdateEMVRIDResult(true)}}}else{console.log("onReturnUpdateEmvCAPKResult"+false);mListener.onReturnUpdateEMVRIDResult(false)}mOperationType=null}var mEmvAppCfg="";var mEmvCapkCfg="";function updateEmvConfig(emvAppCfg,emvCapkCfg){if(isEmpty(emvAppCfg)||emvAppCfg.length%2!=0){return
}if(isEmpty(emvCapkCfg)||emvCapkCfg.length%2!=0){return}mOffset=0;mCustomParamString="";mCustomParam=null;mEmvAppCfg=emvAppCfg;mEmvCapkCfg=emvCapkCfg;doUpdateCustomParam(CustomParam.CUSTOM_PARAM_SEG_EMV_APP,0,mEmvAppCfg)}var mOffset=0;var mCustomParamString="";var mCustomParam;function doUpdateCustomParam(customParam,offset,customParamString){mOffset=offset;mCustomParamString=customParamString;mCustomParam=customParam;var customParamSize=customParamString.length/2;startSendCustomParam(OperationLogo.WRITE,customParam,customParamSize).then(function(data){if(getResult()==0){console.log("startSendCustomParam success! ");return updateCustomParam()}},function(reason){console.log(reason)})}function startSendCustomParam(opLogo,customParam,customParamSize){var aStr="";if(opLogo==OperationLogo.READ){aStr+="00"}else{aStr+="01"}if(customParam==CustomParam.CUSTOM_PARAM_SEG_EMV_APP){aStr+="00"}else{if(customParam==CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK){aStr+="01"}else{if(customParam==CustomParam.CUSTOM_PARAM_SEG_CUSTOM1){aStr+="02"}else{if(customParam==CustomParam.CUSTOM_PARAM_SEG_CUSTOM2){aStr+="03"}}}}var tmp=customParamSize;var hh=tmp>>24;var hl=(tmp>>16)&255;var lh=(tmp>>8)&255;var ll=(tmp)&255;aStr+=byteArray2Hex(intToHex(hh));aStr+=byteArray2Hex(intToHex(hl));aStr+=byteArray2Hex(intToHex(lh));aStr+=byteArray2Hex(intToHex(ll));aStr+="10";CommandDownlink2(22,144,15,hexStr2Bytes(aStr));var datas=getDownPBytes();console.log(byteArray2Hex(datas));return startSysSession(new Uint8Array(datas).buffer,null,5)}var mUpdateCustomParamResolve=function(){console.log("BT success")};var mUpdateCustomParamReject=function(){console.log("BT success")};function updateCustomParam(){var aStr="";var arrs=hexStr2Bytes(mCustomParamString);var customParamSize=mCustomParamString.length/2;var tmp=mOffset;var hh=tmp>>24;var hl=(tmp>>16)&255;var lh=(tmp>>8)&255;var ll=(tmp)&255;aStr=byteArray2Hex(intToHex(hh));aStr+=byteArray2Hex(intToHex(hl));aStr+=byteArray2Hex(intToHex(lh));aStr+=byteArray2Hex(intToHex(ll));
tmp=customParamSize-mOffset;if(tmp>WRITE_MAX_LEN){tmp=WRITE_MAX_LEN}lh=(tmp>>8)&255;ll=(tmp)&255;aStr+=byteArray2Hex(intToHex(lh));aStr+=byteArray2Hex(intToHex(ll));var tmparrs=new Array(tmp);arrCopyArr(arrs,mOffset,tmparrs,0,tmp);aStr+=byteArray2Hex(tmparrs);CommandDownlink2(22,160,15,hexStr2Bytes(aStr));var datas=getDownPBytes();console.log(byteArray2Hex(datas));mOffset+=tmp;startSession(new Uint8Array(datas).buffer,onUpdateCustomParam,5)}function onUpdateCustomParam(receivedData){console.log("onQposIdResult----------"+receivedData+"commid----------"+receivedData.substring(6,8));if(getResult()==0){var customParamSize=mCustomParamString.length/2;var absParamSize=customParamSize-(customParamSize%1000);if(mOffset<customParamSize){console.log("onUpdateCustomParam mOffset�� "+mOffset+"onUpdateCustomParam customParamSize��"+customParamSize);updateCustomParam()}else{console.log("onUpdateCustomParam success!______ "+mOffset);stopSendCustomParam(OperationLogo.WRITE,mCustomParam)}}else{mListener.onReturnCustomConfigResult(false)}}function stopSendCustomParam(opLogo,customParam){console.log("stopSendCustomParam"+customParam);var aStr="";if(opLogo==OperationLogo.READ){aStr+="00"}else{aStr+="01"}if(customParam==CustomParam.CUSTOM_PARAM_SEG_EMV_APP){aStr+="00"}else{if(customParam==CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK){aStr+="01"}else{if(customParam==CustomParam.CUSTOM_PARAM_SEG_CUSTOM1){aStr+="02"}else{if(customParam==CustomParam.CUSTOM_PARAM_SEG_CUSTOM2){aStr+="03"}}}}CommandDownlink2(22,145,15,hexStr2Bytes(aStr));var datas=getDownPBytes();console.log(byteArray2Hex(datas));if(customParam==CustomParam.CUSTOM_PARAM_SEG_EMV_APP){startSysSession(new Uint8Array(datas).buffer,null,5).then(function(data){doUpdateCustomParam(CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK,0,mEmvCapkCfg)},function(reason){})}else{startSysSession(new Uint8Array(datas).buffer,null,5);mListener.onReturnCustomConfigResult(true)}}var OperationLogo={};OperationLogo.READ=0;OperationLogo.WRITE=1;var CustomParam={};CustomParam.CUSTOM_PARAM_SEG_CUSTOM1=0;
CustomParam.CUSTOM_PARAM_SEG_CUSTOM2=1;CustomParam.CUSTOM_PARAM_SEG_EMV_APP=2;CustomParam.CUSTOM_PARAM_SEG_EMV_CAPK=3;
var CardTradeMode={};CardTradeMode.CardTradeMode_ONLY_INSERT_CARD=0;CardTradeMode.CardTradeMode_ONLY_SWIPE_CARD=1;CardTradeMode.CardTradeMode_SWIPE_INSERT_CARD=2;CardTradeMode.CardTradeMode_UNALLOWED_LOW_TRADE=3;CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD=4;CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_UNALLOWED_LOW_TRADE=5;CardTradeMode.CardTradeMode_ONLY_TAP_CARD=6;CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP=7;CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP_UNALLOWED_LOW_TRADE=8;CardTradeMode.CardTradeMode_TAP_INSERT_CARD=9;CardTradeMode.CardTradeMode_TAP_INSERT_CARD_NOTUP=10;CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_DOWN=11;
