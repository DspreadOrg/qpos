var DoTrade=function(a){writeObj(a);mListener=a;console.log("DoTrade init"+mListener);writeObj(this)};var mListener;var EmvOption={};EmvOption.START=0;EmvOption.START_WITH_FORCE_ONLINE=1;var DoTradeMode={};DoTradeMode.COMMON=0;DoTradeMode.CHECK_CARD_NO_IPNUT_PIN=1;DoTradeMode.IS_DEBIT_OR_CREDIT=2;var TransactionResult={APPROVED:"APPROVED",TERMINATED:"TERMINATED",DECLINED:"DECLINED",CANCEL:"CANCEL",CAPK_FAIL:"CAPK_FAIL",NOT_ICC:"NOT_ICC",SELECT_APP_FAIL:"SELECT_APP_FAIL",DEVICE_ERROR:"DEVICE_ERROR",CARD_NOT_SUPPORTED:"CARD_NOT_SUPPORTED",MISSING_MANDATORY_DATA:"MISSING_MANDATORY_DATA",CARD_BLOCKED_OR_NO_EMV_APPS:"CARD_BLOCKED_OR_NO_EMV_APPS",INVALID_ICC_DATA:"INVALID_ICC_DATA",FALLBACK:"FALLBACK",NFC_TERMINATED:"NFC_TERMINATED",CARD_REMOVED:"CARD_REMOVED",TRADE_LOG_FULL:"TRADE_LOG_FULL",TRANSACTION_NOT_ALLOWED_AMOUNT_EXCEED:"TRANSACTION_NOT_ALLOWED_AMOUNT_EXCEED"};var mTradeAmount;var mCurrencyCode;var mCashbackAmount;var mTradeType;var mDoTradeMode=DoTradeMode.COMMON;var mCardTmode=CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD;var mAmountIcon="";var cDisplayStr="";var mFormatId="";var mBatchId="";var mAmountPoint="";var mSaveLogFlag="";var mIsSupportCashBack=false;const FINA_CONFIRM="03";const BATCH_DC="04";const OFFLINE_ADVICE="05";const ONLINE_ADVICE="06";const REVERSAL="07";const EMV_TRANS_ACCEPT="01";const EMV_TRANS_DENIAL="02";const EMV_TRANS_GOONLINE="03";function setAmountPoint(a){if(a){mAmountPoint="01"}else{mAmountPoint="00"}}function isSavelog(a){if(a){mSaveLogFlag="01"}else{mSaveLogFlag="00"}}function setAmount(c,b,a,d){console.log("setAmount:"+c+"setAcashbackAmount:"+b);mTradeAmount=c;mCashbackAmount=b;mCurrencyCode=a;console.log("transactionType :"+d);mTradeType=toHex(d).substr(2,2);console.log("setAmount tradeType: "+mTradeType)}function setDoTradeMode(a){mDoTradeMode=a}function setFormatId(a){mFormatId=a}function setBatchId(a){mBatchId=a}function setCardTmodeMode(a){mCardTmode=a}DoTrade.prototype.doTrade=function(b,a){doTrade(b,a)};DoTrade.prototype.doCheckCard=function(b,a){setDoTradeMode(DoTradeMode.CHECK_CARD_NO_IPNUT_PIN);doTrade(b,a)};DoTrade.prototype.selectEmvApp=function(a){console.log("EMVSelectEMVApp");EMVSelectEMVApp(a)};DoTrade.prototype.sendOnlineProcessResult=function(a){console.log("go online");EMVGoOnLine(a)};function doTrade(b,a){if(b>=10){return}EmvPolCard(mTradeAmount,a,mAmountIcon,b,mCardTmode,mTradeType,mCurrencyCode,cDisplayStr)}function EmvPolCard(m,J,D,p,k,o,F,l){var A=0;var v=new Array();var f=new Array();var r=new Array();var a=new Array();var H=new Array();var G=new Array();var i=new Array();var c=new Array();var y=new Array();var z=new Array();var x=0;if(!isEmpty(D)){v=hexStr2Bytes(D.trim());x=v.length}var g=0;if(!isEmpty(m)){f=getUTF8Bytes(m.trim());g=f.length}var w=getFormatDateyyyyMMddHHmmss();var t=0;if(!isEmpty(w)){r=hexStr2Bytes(w.trim());t=r.length}var b=0;var C=l;if(!isEmpty(C)){a=hexStr2Bytes(C.trim());b=a.length}var I=0;if(!isEmpty(mFormatId)){H=hexStr2Bytes(mFormatId.trim());I=H.length}var n=0;if(!isEmpty(mBatchId)){G=hexStr2Bytes(mBatchId.trim());n=G.length}var j=0;if(!isEmpty(mAmountPoint)){i=hexStr2Bytes(mAmountPoint.trim());j=i.length}var d=0;if(!isEmpty(mSaveLogFlag)){c=hexStr2Bytes(mSaveLogFlag.trim());d=c.length}var s=0;var E="00";if(!isEmpty(E)){y=hexStr2Bytes(E.trim());s=y.length}var u="313431323137";z=hexStr2Bytes(u);var q=z.length;var K=1+g+1+1+x+1+1+t+1+1+1+1+1+1+2+1+b+8+1+I+1+n+1+j+1+d+1+s+1+q;var e=new Array(K);e[A++]=g;arrCopyArr(f,0,e,A,g);A+=g;if(k==CardTradeMode.CardTradeMode_ONLY_INSERT_CARD){e[A++]=1}else{if(k==CardTradeMode.CardTradeMode_ONLY_SWIPE_CARD){e[A++]=2}else{if(k==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD){e[A++]=3}else{if(k==CardTradeMode.CardTradeMode_UNALLOWED_LOW_TRADE){e[A++]=4}else{if(k==CardTradeMode.CardTradeMode_SWIPE_INSERT_CARD){e[A++]=5}else{if(k==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_UNALLOWED_LOW_TRADE){e[A++]=6}else{if(k==CardTradeMode.CardTradeMode_ONLY_TAP_CARD){e[A++]=7}else{if(k==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP){e[A++]=8}else{if(k==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_NOTUP_UNALLOWED_LOW_TRADE){e[A++]=9}else{if(k==CardTradeMode.CardTradeMode_TAP_INSERT_CARD){e[A++]=11}else{if(k==CardTradeMode.CardTradeMode_TAP_INSERT_CARD_NOTUP){e[A++]=10}else{if(k==CardTradeMode.CardTradeMode_SWIPE_TAP_INSERT_CARD_DOWN){e[A++]=12}else{e[A++]=3}}}}}}}}}}}}e[A++]=x;arrCopyArr(v,0,e,A,x);A+=x;if(mDoTradeMode==DoTradeMode.CHECK_CARD_NO_IPNUT_PIN){e[A++]=1}else{if(mDoTradeMode==DoTradeMode.IS_DEBIT_OR_CREDIT){e[A++]=3}else{e[A++]=0}}e[A++]=t;arrCopyArr(r,0,e,A,t);A+=t;e[A++]=0;e[A++]=0;e[A++]=p;e[A++]=0;e[A++]=1;if(!isEmpty(o)){o="01"}e[A++]=hexStr2Bytes(o)[0];if(!isEmpty(F)){F="0156"}if(F.length==3){F="0"+F}e[A++]=hexStr2Bytes(F)[0];e[A++]=hexStr2Bytes(F)[1];e[A++]=b;arrCopyArr(a,0,e,A,b);A+=b;e[A++]=I;arrCopyArr(H,0,e,A,H.length);A+=I;e[A++]=n;arrCopyArr(G,0,e,A,G.length);A+=n;e[A++]=j;arrCopyArr(i,0,e,A,i.length);A+=j;e[A++]=d;arrCopyArr(c,0,e,A,c.length);A+=d;e[A++]=s;
arrCopyArr(y,0,e,A,y.length);A+=s;e[A++]=q;arrCopyArr(z,0,e,A,z.length);A+=q;var B=calMac(e,e.length-8);arrCopyArr(B,0,e,A,8);A+=8;console.log("emvpollcard=="+e);CommandDownlink2(22,32,J,e);var h=getDownPBytes();console.log(byteArray2Hex(h));startSession(new Uint8Array(h).buffer,onReceiveDateListener,15)}function onReceiveDateListener(b){console.log("onReceiveDateListener----------"+b+"commid----------"+b.substring(6,8));if(b.substring(18,20)=="01"&&b.substring(8,12)=="1620"){mListener.onDoTradeResult(DoTradeResult.ICC,null);var c=EMVStart(EmvOption.START);CommandDownlink2(22,48,60,c);var r=getDownPBytes();console.log(byteArray2Hex(r));startSession(new Uint8Array(r).buffer,onReceiveDateListener,5)}else{if(b.substring(18,20)=="00"&&b.substring(8,12)=="1620"){print("this is MRC card ");checkCardResult(DoTradeResult.MCR,b)}else{if(b.substring(18,20)=="03"&&b.substring(8,12)=="1620"){print("NFC_ONLINE");checkCardResult(DoTradeResult.NFC_ONLINE,b)}else{if(b.substring(18,20)=="04"&&b.substring(8,12)=="1620"){print("NFC_OFFLINE");checkCardResult(DoTradeResult.NFC_OFFLINE,b)}else{if(b.substring(18,20)=="05"&&b.substring(8,12)=="1620"){print("NFC_DECLINED");mListener.onDoTradeResult(DoTradeResult.NFC_DECLINED,null)}else{if(b.substring(6,8)=="24"&&b.substring(8,12)=="1630"){var q=parseInt(b.substring(14,18),16);var s=b.substring(18,18+q*2);console.log("dataStra=="+s);console.log("receive  len"+q);if(b.substring(12,14)=="02"){var n=new Array();var f=0;var m=parseInt(s.substring(f,f+2),16);console.log("appCount = "+m);f+=2;for(var p=0;p<m;p++){f+=2;f+=2;var t=parseInt(s.substring(f,f+2),16);f+=2;var k=hex2Ascii(s.substring(f,f+t*2));f+=t*2;n.push(k)}mListener.onRequestSelectEmvApp(n)}else{continueEmvProcess(s)}}else{if(b.substring(6,12)=="241640"){console.log("online result==="+b);var q=parseInt(b.substring(14,18),16);console.log("le==+++"+q);var s=bufData+b.substring(18,18+q*2);console.log("111==="+s.length);var e=Str2Bytes(s);console.log("len=="+e.length);var d=analysisEmvResult(e);var g=d[0];var o=d[1];var l=d[2];var h=d[3];var a=d[4];console.log("icc result==="+a);var j=anlysDataCommon(true,a);print("icc result==="+j)}}}}}}}}function continueEmvProcess(b){var e=hexStr2Bytes(b);var h=analysisEmvResult(e);var a=h[0];var g=h[1];var d=h[2];var f=h[3];var c=h[4];if(EMV_TRANS_GOONLINE==a){mListener.onRequestOnlineProcess(c)}else{emvGoOffLine(h)}}function emvGoOffLine(f){var a=f[0];var e=f[1];var c=f[2];var d=f[3];var b=f[4];if(EMV_TRANS_DENIAL.equals(a)){if(ONLINE_ADVICE.equals(e)||OFFLINE_ADVICE.equals(e)){mListener.onRequestDisplay(Display.REMOVE_CARD);mListener.onRequestBatchData(b);mListener.onRequestTransactionResult(TransactionResult.DECLINED);return}else{if(REVERSAL.equals(e)){mListener.onRequestDisplay(Display.REMOVE_CARD);mListener.onReturnReversalData(b);mListener.onRequestTransactionResult(TransactionResult.DECLINED);return}}}else{if(EMV_TRANS_ACCEPT.equals(a)){if(REVERSAL.equals(e)){mListener.onRequestDisplay(Display.REMOVE_CARD);mListener.onReturnReversalData(b);mListener.onRequestTransactionResult(TransactionResult.DECLINED);return}else{if(FINA_CONFIRM.equals(e)||BATCH_DC.equals(e)){mListener.onRequestDisplay(Display.REMOVE_CARD);mListener.onRequestBatchData(b);mListener.onRequestTransactionResult(TransactionResult.APPROVED);return}}}}startSysSession(packageInstructionReset(),null,5);logListaner="onError(Error.UNKNOWN)";console.log(logListener)}function EMVSelectEMVApp(c){var b=new Array();b.push(c);CommandDownlink2(22,49,30,b);var a=getDownPBytes();console.log(byteArray2Hex(a));startSysSession(new Uint8Array(a).buffer,null,60).then(function(g){if(getResult()==0){var f=upPLength();console.log(" length()--"+upPLength());var e=0;var d=byteArray2Hex(getUpPBytes(e,f));continueEmvProcess(d)}},function(d){console.log(d)})}function EMVGoOnLine(b){CommandDownlink2(22,64,30,hexStr2Bytes(b));var a=getDownPBytes();console.log(byteArray2Hex(a));startSession(new Uint8Array(a).buffer,onReceiveDateListener,60)}function checkCardResult(w,s){var q=new Array();console.log("result:"+s);var n=hexStr2Bytes(s.substring(14,14+s.length-16));var g=n[2];var z=4;var X=n.length;var V=n[z++];print("len:"+V);var T=byteArray2Hex(getBytesFromArr(z,V,n));z+=V;q.push(T);var r=n[z++];var Q=byteArray2Hex(getBytesFromArr(z,r,n));z+=r;q.push(Q);var G=n[z++];var N=byteArray2Hex(getBytesFromArr(z,G,n));z+=G;q.push(N);var H=n[z++];var e=ab2str(getBytesFromArr(z,H,n));z+=H;q.push(e);var o=n[z++];var A=ab2str(getBytesFromArr(z,o,n));z+=o;q.push(A);var j=n[z++];var x=ab2str(getBytesFromArr(z,j,n));z+=j;q.push(x);var f=n[z++];var C=ab2str(getBytesFromArr(z,f,n));z+=f;q.push(C);var d=n[z++];var m=ab2str(getBytesFromArr(z,d,n));z+=d;q.push(m);var i=n[z++];var F=byteArray2Hex(getBytesFromArr(z,i,n));z+=i;q.push(F);var B=n[z++];var h=byteArray2Hex(getBytesFromArr(z,B,n));z+=B;q.push(h);var D=n[z++];var I=byteArray2Hex(getBytesFromArr(z,D,n));z+=D;q.push(I);var L;var y;if(z<X){var E=n[z++];L=byteArray2Hex(getBytesFromArr(z,E,n));z+=E;q.push(L);var W=n[z++];
y=byteArray2Hex(getBytesFromArr(z,W,n));z+=W;q.push(y)}else{L="";y=""}var K="";if(z<X){var v=n[z++];K=ab2str(getBytesFromArr(z,v,n));z+=v;q.push(K)}var P;var M;var S;if(z<X){var U=new Array(1);U[0]=n[z++];var t=byteArrayToInt(U);var R=new Array(1);R[0]=n[z++];var J=byteArrayToInt(R);var O=new Array(1);O[0]=n[z++];var l=byteArrayToInt(O);P=t.toString();M=J.toString();S=l.toString()}else{P="";M="";S=""}var p;if(z<X){var u=n[z++];p=byteArray2Hex(getBytesFromArr(z,u,n));z+=u}else{p=""}q.push(p);var k=Q.toString()+N.toString();mListener.onDoTradeResult(w,q)}DoTrade.prototype.getNFCBatchData=function(b,a){return getNFCBatchData(b,a)};function getNFCBatchData(b,a){getICCTag(1,0,"").then(function(c){if(getResult()==0){var c=byteArray2Hex(getUpPBytes(0,upPLength()));print("batch Data:"+c);b(c)}},function(c){a(c);console.log(c)})}DoTrade.prototype.getICCTag=function(a,c,b){return getICCTag(a,c,b)};function getICCTag(b,g,e){var c=new Array();var f="00";f+=byteArray2Hex(intToHex(b));f+=byteArray2Hex(intToHex(b));f+=byteArray2Hex(intToHex(g));if(isEmpty(e)){e="00"}f+=e;var d=hexStr2Bytes(f.trim());CommandDownlink2(22,81,5,d);var a=getDownPBytes();console.log(byteArray2Hex(a));return startSysSession(new Uint8Array(a).buffer,null,5)}var encMode;function analysisEmvResult(q){console.log("analysisEmvResult");var m=new Array();if(q==null||q.length==0){return m}var j=0;j++;encMode=q[j++];var u=new Array(1);u[0]=q[j++];var k=byteArray2Hex(u);var t=new Array(1);t[0]=q[j++];var o=byteArray2Hex(t);var s=new Array(1);s[0]=q[j++];var h=byteArrayToInt(s);var r=new Array(h);arrCopyArr(q,j,r,0,h);var g=byteArray2Hex(r);j+=h;var v=q[j++];r=new Array(v);arrCopyArr(q,j,r,0,v);var l=byteArray2Hex(r);j+=v;var p=new Array(2);p[0]=q[j];p[1]=q[j+1];var e=byteArrayToInt(p);j+=2;r=new Array(e);arrCopyArr(q,j,r,0,e);var f=byteArray2Hex(r);j+=e;var d="";if(j<q.length){r=intToHex(e);var n=byteArray2Hex(r);if(n.length==2){n="00"+n}f=n+f;var i=q.length-j;r=new Array(i);arrCopyArr(q,j,r,0,i);d=byteArray2Hex(r);j+=e}f+=d;m.push(k);m.push(o);m.push(g);m.push(l);m.push(f);console.log("end analysisEmvResult"+encMode);print("hashtable:",m);return m}function anlysDataCommon(Q,b){var o=new Array();if(encMode==0||encMode==16||encMode==38||encMode==48){o.push(b);return o}var H=Str2Bytes(b);var ab=H.length;var A=0;var r=new Array(2);r[0]=H[A];r[1]=H[A+1];var j=byteArrayToInt(r);A+=2;var h=new Array(j);arrCopyArr(H,A,h,0,j);var i=byteArray2Hex(h);A+=j;if(A>=ab){o.push(i);return o}A+=2;var Y=H[A++];var k=new Array(Y);arrCopyArr(H,A,k,0,Y);var X=byteArray2Hex(k);A+=Y;var s=H[A++];k=new Array(s);arrCopyArr(H,A,k,0,s);var V=byteArray2Hex(k);A+=s;var J=H[A++];k=new Array(J);arrCopyArr(H,A,k,0,J);var T=byteArray2Hex(k);A+=J;var K=H[A++];k=new Array(K);arrCopyArr(H,A,k,0,K);var c=ab2str(k);A+=K;var p=H[A++];k=new Array(p);arrCopyArr(H,A,k,0,p);var B=ab2str(k);A+=p;var m=H[A++];k=new Array(m);arrCopyArr(H,A,k,0,m);var y=ab2str(k);A+=m;var d=H[A++];k=new Array(d);arrCopyArr(H,A,k,0,d);var E=ab2str(k);A+=d;var a=H[A++];var Z=ab2str(k);A+=a;var l=H[A++];k=new Array(l);arrCopyArr(H,A,k,0,l);var I=byteArray2Hex(k);A+=l;var C=H[A++];k=new Array(C);arrCopyArr(H,A,k,0,C);var g=byteArray2Hex(k);A+=C;var F=H[A++];k=new Array(F);arrCopyArr(H,A,k,0,F);var L=byteArray2Hex(k);A+=F;var R="";var z="";if(A<ab){var G=H[A++];k=new Array(G);arrCopyArr(H,A,k,0,G);R=byteArray2Hex(k);A+=G}if(A<ab){var aa=H[A++];k=new Array(aa);arrCopyArr(H,A,k,0,aa);z=byteArray2Hex(k);A+=aa}var O="";if(A<ab){var w=H[A++];k=new Array(w);arrCopyArr(H,A,k,0,w);O=ab2str(k);A+=w}var U="";var S="";var W="";if(A<ab){var u=H[A++];var M=H[A++];var n=H[A++];U=u+"";S=M+"";W=n+""}var q="";if(A<ab){var v=H[A++];k=new Array(v);arrCopyArr(H,A,k,0,v);q=byteArray2Hex(k);A+=v}var e="";var P="";if(A<ab){var t=H[A++];var D=new Array(t);arrCopyArr(H,A,D,0,t);e=byteArray2Hex(D);A+=t}if(A<ab){var N=H[A++];var x=new Array(N);arrCopyArr(H,A,x,0,N);P=byteArray2Hex(x);A+=N}o.push(c);o.push(B);o.push(y);o.push(Z);o.push(E);o.push(U);o.push(S);o.push(W);o.push(X);o.push(V);o.push(T);o.push(I);o.push(R);o.push(z);o.push(O);o.push(q);o.push(i);o.push(e);o.push(g);o.push(L);console.log("hashtable end+++++++");return o}function EMVStart(a){console.log("EMVStart>> tradeAmount: "+mTradeAmount);var d=14+2+2+1+mTradeAmount.length+1+mCashbackAmount.length+2+1;var i=new Array(d);var e=0;if(a==EmvOption.START){i[e++]=0}else{if(a==EmvOption.START_WITH_FORCE_ONLINE){i[e++]=1}}i[e++]=hexStr2Bytes(mTradeType)[0];var h;var b=getFormatDateyyyyMMddHHmmss();if(mTradeAmount.length<=8){h=hexStr2Bytes(b+"FF")}else{h=hexStr2Bytes(b+"06")}arrCopyArr(h,0,i,e,h.length);e+=h.length;var g="";if(mTradeAmount.length>8){g="FFFFFFFFFFFF"}else{g="FFFFFFFF"}var f=0;if(!isEmpty(mTradeAmount)){f=mTradeAmount.length}g=g.substring(0,g.length-f)+mTradeAmount;h=hexStr2Bytes(g);arrCopyArr(h,0,i,e,h.length);e+=h.length;if(mTradeAmount.length>8){g=""}else{g="0000"}if(mCurrencyCode.length==3){mCurrencyCode="0"+mCurrencyCode}g+=mCurrencyCode;h=hexStr2Bytes(g);arrCopyArr(h,0,i,e,h.length);
e+=h.length;i[e++]=(mTradeAmount.length+1);arrCopyArr(getUTF8Bytes(mTradeAmount),0,i,e,mTradeAmount.length);e+=mTradeAmount.length;i[e++]=0;i[e++]=(mCashbackAmount.length+1);arrCopyArr(getUTF8Bytes(mCashbackAmount),0,i,e,mCashbackAmount.length);e+=mCashbackAmount.length;i[e++]=0;var c=intToHex(20);arrCopyArr(c,0,i,e++,1);return i};