function commandCode(){return getCmdCode()}function subCommandCode(){return getCmdSubCode()}function getResult(){return getResultCode()}function commandID(){return getCmdID()}function upPLength(){var aLe=new Array();aLe[0]=getPByte(3);aLe[1]=getPByte(4);return byteArrayToInt(aLe)}function getUpPByte(offset){return getDataFieldByte(offset)}function getUpPBytes(offset,len){var r=new Array();for(var i=0;i<len;i++){r[i]=getDataFieldByte(offset+i)}return r}function getAllBytes(){return getPBytes()}function validCRC(){return validPCRC()}function packageCommandUplink(paras){var ss=hexStr2Bytes(paras.substring(10,paras.length));packet(paras.length/2-5);setCmdID(CmdId.CMDID_COMPLETED);setCmdCode(parseInt(paras.substring(0,2),16));setCmdSubCode(parseInt(paras.substring(2,4),16));setTimeOut(0);setDataField(ss);buildCRC()};
function CommandDownlink(cmdCode,cmdSubCode,delay){packCmmandDownlink(33,cmdCode,cmdSubCode,delay,new Array())}function CommandDownlink2(cmdCode,cmdSubCode,delay,paras){packCmmandDownlink(33,cmdCode,cmdSubCode,delay,paras)}function CommandDownlink3(cmdID,cmdCode,cmdSubCode,delay,paras){packCmmandDownlink(cmdID,cmdCode,cmdSubCode,delay,paras)}function CommandDownlink4(cmdID,cmdCode,cmdSubCode,delay){packCmmandDownlink(cmdID,cmdCode,cmdSubCode,delay,new Array())}function getDownPByte(offset){return getPByte(offset)}function getDownPBytes(){return getPBytes()}function packCmmandDownlink(cmdID,cmdCode,cmdSubCode,delay,paras){packet(paras.length);setCmdID(cmdID);setCmdCode(cmdCode);setCmdSubCode(cmdSubCode);setTimeOut(delay);setDataField(paras);buildCRC()};
function anlycPosInfo(){var deviceInfoData=new Array();var countLen=upPLength();console.log(" length()--"+upPLength());var index=0;var bootloaderVersionLen=getUpPByte(index++);var bootloaderVersion=byteArray2Hex(getUpPBytes(index,bootloaderVersionLen));bootloaderVersion=hex2Ascii(bootloaderVersion);index+=bootloaderVersionLen;var firmwareVersionLen=getUpPByte(index++);var firmwareVersion=byteArray2Hex(getUpPBytes(index,firmwareVersionLen));firmwareVersion=hex2Ascii(firmwareVersion);index+=firmwareVersionLen;var hardwareVersionLen=getUpPByte(index++);var hardwareVersion=byteArray2Hex(getUpPBytes(index,hardwareVersionLen));hardwareVersion=hex2Ascii(hardwareVersion);var SUB="";if(hardwareVersion.length>3){SUB=hardwareVersion.substr(3,hardwareVersionLen);hardwareVersion=hardwareVersion.substr(0,3)}index+=hardwareVersionLen;var batteryLevelLen=getUpPByte(index++);console.log("batteryLevelLen:"+batteryLevelLen);var batteryLevel=byteArrayToInt(getUpPBytes(index,batteryLevelLen))+" mV";index+=batteryLevelLen;var isChargingLen=getUpPByte(index++);var isCharging=byteArray2Hex(getUpPBytes(index,isChargingLen));if(isCharging=="00"){isCharging="false"}else{isCharging="true"}index+=isChargingLen;var isUsbConnectedLen=getUpPByte(index++);var isUsbConnected=byteArray2Hex(getUpPBytes(index,isUsbConnectedLen));if(isUsbConnected=="00"){isUsbConnected="false"}else{isUsbConnected="true"}index+=isUsbConnectedLen;var isSupportedTrack1Len=getUpPByte(index++);var isSupportedTrack1=byteArray2Hex(getUpPBytes(index,isSupportedTrack1Len));if(isSupportedTrack1=="00"){isSupportedTrack1="false"}else{isSupportedTrack1="true"}index+=isSupportedTrack1Len;var isSupportedTrack2Len=getUpPByte(index++);var isSupportedTrack2=byteArray2Hex(getUpPBytes(index,isSupportedTrack2Len));if(isSupportedTrack2=="00"){isSupportedTrack2="false"}else{isSupportedTrack2="true"}index+=isSupportedTrack2Len;var isSupportedTrack3Len=getUpPByte(index++);var isSupportedTrack3=byteArray2Hex(getUpPBytes(index,isSupportedTrack3Len));
if(isSupportedTrack3=="00"){isSupportedTrack3="false"}else{isSupportedTrack3="true"}index+=isSupportedTrack3Len;var dataEncryptionMode="";if(index<countLen){var dataEncryptionModeLen=getUpPByte(index++);dataEncryptionMode=byteArray2Hex(getUpPBytes(index,dataEncryptionModeLen));index+=dataEncryptionModeLen}console.log("dataEncryptionMode: "+dataEncryptionMode);var updateWorkKeyFlag="";if(index<countLen){var updateWorkKeyFlagLen=getUpPByte(index++);updateWorkKeyFlag=byteArray2Hex(getUpPBytes(index,updateWorkKeyFlagLen));if(updateWorkKeyFlag=="00"){updateWorkKeyFlag="false"}else{updateWorkKeyFlag="true"}index+=updateWorkKeyFlagLen}var keyboardflag="";if(index<countLen){var keyboardflaglen=getUpPByte(index++);keyboardflag=byteArray2Hex(getUpPBytes(index,keyboardflaglen));if(keyboardflag=="00"){keyboardflag="false"}else{keyboardflag="true"}index+=keyboardflaglen}var batteryPercentage="";if(index<countLen){var batteryPercentagelen=getUpPByte(index++);var al=getUpPBytes(index,batteryPercentagelen)[0];if(al>100){al=100}else{if(al<0){al=0}}batteryPercentage=al.toString(10);batteryPercentage=batteryPercentage+"%";index+=batteryPercentagelen}deviceInfoData.push(isSupportedTrack1);deviceInfoData.push(isSupportedTrack2);deviceInfoData.push(isSupportedTrack3);deviceInfoData.push(bootloaderVersion);deviceInfoData.push(firmwareVersion);deviceInfoData.push(isUsbConnected);deviceInfoData.push(isCharging);deviceInfoData.push(batteryLevel);deviceInfoData.push(hardwareVersion);deviceInfoData.push(SUB);deviceInfoData.push(updateWorkKeyFlag);deviceInfoData.push(keyboardflag);deviceInfoData.push(batteryPercentage);console.log("设备信息："+deviceInfoData);return deviceInfoData}function anlycPosId(){var deviceIdData=new Array();var countLen=upPLength();var index=0;var psamIdLen=getUpPByte(index++);var psamId=byteArray2Hex(getUpPBytes(index,psamIdLen));index+=psamIdLen;var posIdLen=getUpPByte(index++);var posId=byteArray2Hex(getUpPBytes(index,posIdLen));index+=posIdLen;console.log("posId:"+posId);var merchantId="";
var vendorCode="";var deviceNumber="";var psamNo="";var merchantIdLen=getUpPByte(index++);merchantId=byteArray2Hex(getUpPBytes(index,merchantIdLen));index+=merchantIdLen;var vendorCodeLen=getUpPByte(index++);vendorCode=byteArray2Hex(getUpPBytes(index,vendorCodeLen));index+=vendorCodeLen;if(index<countLen){var deviceNumberLen=getUpPByte(index++);deviceNumber=byteArray2Hex(getUpPBytes(index,deviceNumberLen));index+=deviceNumberLen;var psamNoLen=getUpPByte(index++);psamNo=byteArray2Hex(getUpPBytes(index,psamNoLen));index+=psamNoLen}var csn="";if(index<countLen){var csnLen=getUpPByte(index++);csn=byteArray2Hex(getUpPBytes(index,csnLen));index+=csnLen}var tmk0Status="";var tmk1Status="";var tmk2Status="";var tmk3Status="";var tmk4Status="";if(index<countLen){var tmk0Len=getUpPByte(index++);tmk0Status=byteArray2Hex(getUpPBytes(index,tmk0Len));index+=tmk0Len;var tmk1Len=getUpPByte(index++);tmk1Status=byteArray2Hex(getUpPBytes(index,tmk1Len));index+=tmk1Len;var tmk2Len=getUpPByte(index++);tmk2Status=byteArray2Hex(getUpPBytes(index,tmk2Len));index+=tmk2Len;var tmk3Len=getUpPByte(index++);tmk3Status=byteArray2Hex(getUpPBytes(index,tmk3Len));index+=tmk3Len;var tmk4Len=getUpPByte(index++);tmk4Status=byteArray2Hex(getUpPBytes(index,tmk4Len));index+=tmk4Len}var keyboardflag="";if(index<countLen){var keyboardflaglen=getUpPByte(index++);keyboardflag=byteArray2Hex(getUpPBytes(index,keyboardflaglen));if(keyboardflag=="00"){keyboardflag="false"}else{keyboardflag="true"}index+=keyboardflaglen}console.log("posid: "+posId+"PINPANId: "+deviceNumber);deviceIdData.push(posId);deviceIdData.push(psamId);console.log("设备id："+deviceIdData);return deviceIdData};
var CmdId={CMDID_WAITING:35,CMDID_QUERY:34,CMDID_PART_DATA:54,CMDID_OLD:0,CMDID_RESET:32,CMDID_PROCESS:33,CMDID_COMPLETED:36,CMDID_TIMEOUT:37,CMDID_DESTRUCT:38,CMDID_CRCERROR:39,CMDID_USERCANCEL:40,CMDID_MACERROR:41,CMDID_ICC_INIT_ERROR:48,CMDID_ICC_POWER_ON_ERROR:49,CMDID_ICC_TRADE_ERROR:50,CMDID_EMV_TRANS_TERMINATE:51,CMDID_EMV_TRANS_DENIAL:52,CMDID_NOT_AVAILABLE:53,CMDID_COMPLETED_ENCRY:136,CMDID_EMV_APP_CFG_ERROR:55,CMDID_EMV_CAPK_CFG_ERROR:56,CMDID_WR_DATA_ERROR:57,CMDID_NO_UPDATE_WORK_KEY:64,CMDID_INPUT_PIN_ING:65,CMDID_MAG_TO_ICC_TRADE:66,CMDID_SEND_IC_CARDNO:67,CMDID_EMV_TRANS_CARD_BLOCKED_OR_EMV_APPS:68,CMDID_EMV_TRANS_SELECT_APP_FAILED:69,CMDID_EMV_TRANS_CAPK_FAILED:70,CMDID_EMV_TRANS_FALLBACK:71,CMDID_EMV_TRANS_TERMINATE_NFC:72,CMDID_CARD_REMOVED:81,CMDID_MSR_DATA_READY:82,CMDID_EMV_KERNEL_PC:73,CMDID_CHECK_HAVE_CARD:137};
